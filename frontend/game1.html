<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Voice Boom</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri&family=Scheherazade+New:wght@400;700&family=Noto+Naskh+Arabic:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Noto Naskh Arabic', sans-serif;
            color: #E0E0E0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
            overflow-x: hidden;
            position: relative;
            z-index: 0;

            background-image: url('images/background_image.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-blend-mode: overlay;
            background-color: rgba(0, 0, 0, 0.6);
        }

        .header-container {
            display: flex;
            justify-content: space-between; /* للحفاظ على المساحة بين العناصر */
            align-items: center;
            width: 100%;
            max-width: 1200px;
            margin-bottom: 20px;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px 20px;
            border-radius: 10px;
            position: relative; /* لتمكين وضع العناصر الفرعية بشكل مطلق إذا لزم الأمر */
        }

        .top-left {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-grow: 1; /* للسماح لها بأخذ المساحة المتاحة ودفع العناصر الأخرى */
        }

        /* حاوية جديدة للشعار والعنوان لتوسيطهما */
        .centered-header-content {
            position: absolute; /* وضع مطلق لتوسيطها بغض النظر عن العناصر الأخرى */
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1; /* تأكد أنها فوق عناصر أخرى إذا تداخلت */
        }

        .logo {
            width: 70px; /* زيادة حجم الشعار */
            height: 70px; /* زيادة حجم الشعار */
            border-radius: 50%;
            border: 2px solid #3498db;
            object-fit: cover;
        }

        .game-title {
            font-family: 'Amiri', serif;
            font-size: 3em; /* زيادة حجم الخط لاسم اللعبة */
            color: #3498db;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.7);
            margin: 0;
        }
        
        @keyframes pulse {
            from { transform: scale(1); opacity: 1; }
            to { transform: scale(1.05); opacity: 0.8; }
        }


        .player-info {
            font-size: 1.1em;
            color: #E0E0E0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .player-info i {
            color: #27ae60;
        }

        .top-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .settings-button-group {
            display: flex;
            gap: 10px;
        }

        .action-button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease, transform 0.1s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .action-button:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }

        .action-button:disabled {
            background-color: #7f8c8d;
            cursor: not-allowed;
        }

        /* تعديل الأزرار لتكون في صف واحد */
        .game-container .action-buttons-group {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            gap: 10px; /* مسافة بين الأزرار */
            flex-wrap: wrap; /* للسماح للأزرار بالانتقال إلى سطر جديد إذا كان هناك الكثير منها */
        }

        #singleShotButton { 
            background-color: #28a745; /* لون أخضر */
        }
        #singleShotButton:hover { 
            background-color: #218838;
        }

        #tripleShotButton {
            background-color: #e67e22; /* لون برتقالي */
        }
        #tripleShotButton:hover {
            background-color: #d35400;
        }

        #hammerShotButton { 
            background-color: #6C757D; /* لون رمادي */
        }
        #hammerShotButton:hover {
            background-color: #5A6268;
        }

        .game-container {
            background-color: rgba(44, 62, 80, 0.9);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
            text-align: center;
            width: 100%;
            max-width: 1200px;
            margin-top: 20px;
            position: relative; /* مهم لوضع صورة المؤشر بداخله */
        }

        .messages-area {
            min-height: 50px; 
            margin-bottom: 20px;
            padding: 10px 15px; 
            border-radius: 8px;
            background-color: rgba(0, 0, 0, 0.6); 
            font-size: 1.8em; 
            font-weight: bold;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.8); 
            
            display: flex;
            align-items: center;
            justify-content: center;
            
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.7);
            transition: box-shadow 0.3s ease-in-out; 
            color: #e0e0e0; 
        }
        
        .messages-area.win-glow {
            box-shadow: 0 0 25px 10px rgba(40, 167, 69, 0.9), 
                        0 0 40px 15px rgba(40, 167, 69, 0.7); 
            color: #d4edda; 
        }

        .messages-area.lose-glow {
            box-shadow: 0 0 25px 10px rgba(220, 53, 69, 0.9), 
                        0 0 40px 15px rgba(220, 53, 69, 0.7); 
            color: #f8d7da; 
        }

        .score-board-in-main {
            background-color: rgba(52, 152, 219, 0.8);
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px; 
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            font-size: 1.1em;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 10px;
        }

        .score-board-in-main .score-item {
            font-weight: bold;
            color: #ECF0F1;
        }

        .score-board-in-main .score-item span {
            color: #2C3E50;
            font-size: 0.9em; 
        }

        .boxes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 20px;
            position: relative; /* مهم لوضع صورة المؤشر بداخله و تحديد موضعها */
        }

        .box {
            background-color: #2A9D8F;
            height: 150px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.1s ease, box-shadow 0.3s ease, border 0.3s ease, background-color 0.3s ease, opacity 0.5s ease; 
            border: 2px solid #333333;
            color: #FFFFFF;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7);
            position: relative;
            overflow: hidden;
            
            animation: floatAndGlow 4s infinite ease-in-out;
            box-shadow: 0 0 15px 5px var(--glow-color, rgba(51, 51, 51, 0.5)); 
        }

        .box .box-image {
            max-width: 80%;
            max-height: 80%;
            object-fit: contain;
            margin-bottom: 5px;
        }
        
        @keyframes floatAndGlow {
            0% { 
                transform: translateY(0px) scale(1); 
                box-shadow: 0 0 15px 5px var(--glow-color, rgba(51, 51, 51, 0.5)); 
            }
            25% { 
                transform: translateY(-8px) scale(1.03); 
                box-shadow: 0 0 20px 8px var(--glow-color, rgba(68, 68, 68, 0.7)); 
            }
            50% { 
                transform: translateY(0px) scale(1); 
                box-shadow: 0 0 15px 5px var(--glow-color, rgba(51, 51, 51, 0.5)); 
            }
            75% { 
                transform: translateY(8px) scale(1.03); 
                box-shadow: 0 0 20px 8px var(--glow-color, rgba(68, 68, 68, 0.7)); 
            }
            100% { 
                transform: translateY(0px) scale(1); 
                box-shadow: 0 0 15px 5px var(--glow-color, rgba(51, 51, 51, 0.5)); 
            }
        }
        
        /* ✅ تم تحديث هذا النمط ليكون التوهج النهائي لجميع الضربات */
        .box.single-shot-final-glow {
            animation: finalSingleShotPulse 1s infinite alternate; 
            box-shadow: 0 0 30px 12px rgba(40, 167, 69, 0.9), 
                        0 0 50px 20px rgba(40, 167, 69, 0.7) !important; 
            border-color: #28a745 !important;
            transform: scale(1.07);
        }

        @keyframes finalSingleShotPulse {
            from { box-shadow: 0 0 30px 12px rgba(40, 167, 69, 0.9); }
            to { box-shadow: 0 0 50px 20px rgba(40, 167, 69, 0.7); }
        }

        .box.sequential-glow {
            animation: sequentialPulse 0.8s infinite alternate; 
            box-shadow: 0 0 20px 8px rgba(255, 255, 0, 0.8), 
                        0 0 30px 12px rgba(255, 255, 0, 0.6) !important;
            border-color: #FFD700 !important; 
            transform: scale(1.02);
        }

        @keyframes sequentialPulse {
            from { box-shadow: 0 0 20px 8px rgba(255, 255, 0, 0.8); }
            to { box-shadow: 0 0 30px 12px rgba(255, 255, 0, 0.6); }
        }


        .box:hover:not(.opened) {
            transform: translateY(-12px) scale(1.07);
            animation: none;
            box-shadow: 0 0 30px 12px var(--glow-color, rgba(255, 255, 255, 0.9)) !important; 
        }

        .box.opened {
            cursor: default;
            animation: none !important;
            box-shadow: 0 0 20px 8px rgba(0, 0, 0, 0.8) !important;
            font-size: 3em;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .box.opened .box-image,
        .box.opened .box-text {
            display: none;
        }

        .box.opened.positive-score-10 {
            background-color: #3498DB;
            border: 2px solid #2980B9;
            color: #ECF0F1;
            font-weight: bold;
        }

        .box.opened.positive-score-5 {
            background-color: #9B59B6;
            border: 2px solid #8E44AD;
            color: #ECF0F1;
            font-weight: bold;
        }

        .box.opened.positive-score-1 {
            background-color: #DC143C;
            border: 2px solid #A52A2A;
            color: #ECF0F1;
            font-weight: bold;
        }

        .box.opened.negative-score-5 {
            background-color: #F39C12;
            border: 2px solid #E67E22;
            color: #2C3E50;
            font-weight: bold;
        }

        .box.opened.negative-score-10 {
            background-color: #E74C3C;
            border: 2px solid #C0392B;
            color: #ECF0F1;
            font-weight: bold;
        }

        .logout-button {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .logout-button:hover {
            background-color: #c0392b;
        }

        .volume-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        .volume-controls button {
            background-color: #7f8c8d;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
        }

        .volume-controls button:hover {
            background-color: #95a5a6;
        }

        #volumeSlider {
            width: 100px;
            -webkit-appearance: none;
            height: 8px;
            background: #d3d3d3;
            outline: none;
            opacity: 0.7;
            -webkit-transition: .2s;
            transition: opacity .2s;
            border-radius: 4px;
        }

        #volumeSlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
        }

        #volumeSlider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
        }

        /* أنماط صورة المؤشر المتحركة */
        .seeker-image {
            position: absolute !important; /* فرض الموضع المطلق */
            display: none; /* مخفي في البداية */
            width: 80px; /* تم تعديل الحجم هنا */
            height: 80px; /* تم تعديل الحجم هنا */
            transition: left 1.2s ease-out, top 1.2s ease-out; /* حركة سلسة - تم زيادة المدة هنا */
            z-index: 10; /* لضمان ظهورها فوق الصناديق */
            transform: translate(-50%, -50%); /* لتوسيط الصورة على الإحداثيات */
            border-radius: 50%; /* لجعلها دائرية */
            box-shadow: 0 0 25px 10px rgba(255, 255, 0, 0.9); /* توهج أولي أقوى */
            /* New: Temporary styles for debugging image loading */
            background-color: rgba(255, 0, 0, 0.7); /* Red background if image fails (for NO IMAGE fallback) */
            display: flex; /* To center "NO IMAGE" text */
            align-items: center;
            justify-content: center;
            font-size: 0.9em; /* تم تعديل حجم الخط هنا */
            color: white;
            text-align: center;
            overflow: hidden; /* Prevent text overflow if too long */
            opacity: 1; /* تم تعديل الشفافية هنا لتصبح 100% */
        }

        /* حركة التوهج للصورة عند التحديد النهائي */
        @keyframes finalSeekerPulse {
            from { transform: translate(-50%, -50%) scale(1); opacity: 1; box-shadow: 0 0 25px 10px rgba(255, 255, 0, 0.9); } /* تم تعديل الشفافية والتوهج هنا */
            to { transform: translate(-50%, -50%) scale(1.2); opacity: 1; box-shadow: 0 0 40px 15px rgba(255, 255, 0, 1); } /* تم تعديل الشفافية والتوهج هنا */
        }
    </style>
</head>
<body>
    <div class="header-container">
        <div class="top-left">
            </div>
        <div class="centered-header-content"> <img src="logo.png" alt="شعار اللعبة" class="logo">
            <h1 class="game-title">Voice Boom</h1>
        </div>
        <div class="top-right">
            <div class="player-info">
                <i class="fas fa-user-circle"></i>
                <span id="usernameDisplay"></span> <!-- سيتم ملء هذا بواسطة الجافاسكريبت -->
            </div>
            <div class="settings-button-group">
                <button id="logoutButton" class="logout-button">
                    <i class="fas fa-sign-out-alt"></i> خروج
                </button>
            </div>
        </div>
    </div>

    <div class="game-container">
        <div class="messages-area" id="messagesArea">
            </div>
        
        <div class="action-buttons-group">
            <button id="tripleShotButton" class="action-button">
                <i class="fas fa-bullseye"></i> ضربة ثلاثية (5 قطع نقدية)
            </button>
            <button id="singleShotButton" class="action-button"> 
                <i class="fas fa-crosshairs"></i> ضربة فردية (2 قطعة نقدية)
            </button>
            <button id="hammerShotButton" class="action-button">
                <i class="fas fa-hammer"></i> ضربة المطرقة (20 قطعة نقدية)
            </button>
        </div>
        
        <div class="score-board-in-main" id="scoreBoardMain">
            <div class="score-item">الجولة: <span id="roundNumber">0</span></div>
            <div class="score-item">قطع نقدية الجولة الحالية: <span id="currentRoundPoints">0</span></div>
            <div class="score-item">قطعك النقدية الكلية: <span id="personalScore">0</span></div>
            <div class="score-item">أعلى القطع النقدية: <span id="highScore">0</span></div>
            <!-- ✅ إضافة إحصائيات الضربات هنا -->
            <div class="score-item">ضربات فردية: <span id="singleShotsUsed">0</span></div>
            <div class="score-item">ضربات ثلاثية: <span id="tripleShotsUsed">0</span></div>
            <div class="score-item">ضربات المطرقة: <span id="hammerShotsUsed">0</span></div>
        </div>

        <div id="boxesContainer" class="boxes-grid">
            <!-- سيتم إنشاء الصناديق هنا بواسطة الجافاسكريبت -->
        </div>
        <!-- Moved seekerImage outside boxesContainer, but still within game-container -->
        <img id="seekerImage" src="images/hero.png" alt="شخصية البطل" class="seeker-image" onerror="this.onerror=null; this.src='https://placehold.co/50x50/FF0000/FFFFFF?text=يرجى إضافة hero.png في images'; console.error('خطأ في تحميل hero.png. يرجى التأكد من وجود الملف في images.');">

        <div class="volume-controls">
            <button id="decreaseVolumeBtn"><i class="fas fa-volume-down"></i></button>
            <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.5">
            <button id="increaseVolumeBtn"><i class="fas fa-volume-up"></i></button>
            <button id="muteToggleBtn"><i class="fas fa-volume-mute"></i></button>
        </div>

    </div>

    <audio id="strikeMusic" src="sounds/strike_music.mp3"></audio> 
    <audio id="winSound" src="sounds/win.mp3"></audio>
    <audio id="loseSound" src="sounds/lose.mp3"></audio>

    <script>
        // متغيرات عامة
        let username = null; // سيتم جلبه من السيرفر
        let currentRoundPoints = 0;
        let boxes = [];
        let personalScore = 50; 
        let highScore = 0;
        let roundNumber = 0;
        let numBoxes = 10;
        
        let num10PointsBoxes = 1;
        let num5PointsBoxes = 2;
        let num1PointsBoxes = 3;
        let numNegative5PointsBoxes = 1;
        let numNegative10PointsBoxes = 0;

        let isAdmin = true; 
        let sequentialGlowInterval = null; 
        let sequentialGlowIndex = 0; 
        // ✅ متغيرات جديدة لتتبع إحصائيات الضربات
        let singleShotsUsed = 0;
        let tripleShotsUsed = 0;
        let hammerShotsUsed = 0;


        // تكاليف استخدام الزر
        const SINGLE_SHOT_COST = 2; 
        const TRIPLE_SHOT_COST = 5;
        const HAMMER_SHOT_COST = 20; 
        const HAMMER_SHOT_BOXES = 15; 

        const glowColors = [
            'rgba(52, 152, 219, 0.8)',
            'rgba(155, 89, 182, 0.8)',
            'rgba(220, 20, 60, 0.8)',
            'rgba(243, 156, 18, 0.8)',
            'rgba(231, 76, 60, 0.8)',
            'rgba(46, 204, 113, 0.8)',
            'rgba(241, 196, 15, 0.8)',
            'rgba(189, 195, 199, 0.8)'
        ];

        // عناصر HTML
        const usernameDisplay = document.getElementById('usernameDisplay');
        const messagesArea = document.getElementById('messagesArea');
        const singleShotButton = document.getElementById('singleShotButton'); 
        const tripleShotButton = document.getElementById('tripleShotButton'); 
        const hammerShotButton = document.getElementById('hammerShotButton'); 
        const boxesContainer = document.getElementById('boxesContainer');
        const scoreBoardMain = document.getElementById('scoreBoardMain'); 
        const currentRoundPointsDisplay = document = document.getElementById('currentRoundPoints');
        const personalScoreDisplay = document.getElementById('personalScore');
        const highScoreDisplay = document.getElementById('highScore');
        const roundNumberDisplay = document.getElementById('roundNumber');

        const strikeMusic = document.getElementById('strikeMusic'); 
        const winSound = document.getElementById('winSound');
        const loseSound = document.getElementById('loseSound');
        const logoutButton = document.getElementById('logoutButton');
        const volumeSlider = document.getElementById('volumeSlider');
        const increaseVolumeBtn = document.getElementById('increaseVolumeBtn');
        const decreaseVolumeBtn = document.getElementById('decreaseVolumeBtn');
        const muteToggleBtn = document.getElementById('muteToggleBtn');
        // ✅ عناصر HTML جديدة لإحصائيات الضربات
        const singleShotsUsedDisplay = document.getElementById('singleShotsUsed');
        const tripleShotsUsedDisplay = document.getElementById('tripleShotsUsed');
        const hammerShotsUsedDisplay = document.getElementById('hammerShotsUsed');

        // ✅ عنصر صورة البطل الجديد (المؤشر)
        const seekerImage = document.getElementById('seekerImage');
        
        // وظائف الصوت
        function setVolume(volume) {
            strikeMusic.volume = volume; 
            winSound.volume = volume;
            loseSound.volume = volume;
        }

        function updateVolumeFromSlider() {
            setVolume(volumeSlider.value);
        }

        function increaseVolume() {
            volumeSlider.value = Math.min(parseFloat(volumeSlider.value) + 0.1, 1);
            updateVolumeFromSlider();
            muteToggleBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
        }

        function decreaseVolume() {
            volumeSlider.value = Math.max(parseFloat(volumeSlider.value) - 0.1, 0);
            updateVolumeFromSlider();
            if (volumeSlider.value == 0) {
                muteToggleBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
            }
        }

        function playSound(audioElement, errorMsg) {
            if (audioElement.readyState >= 3) { 
                audioElement.play().catch(e => console.error(errorMsg, e));
            } else {
                console.warn(`Cannot play ${audioElement.id}: Audio element not ready. Current state: ${audioElement.readyState}`);
            }
        }

        function stopAndResetSound(audioElement) { 
            audioElement.pause();
            audioElement.currentTime = 0;
            audioElement.loop = false; // ✅ التأكد من إزالة التكرار
        }

        function toggleMute() {
            if (strikeMusic.muted) { 
                strikeMusic.muted = false; 
                winSound.muted = false;
                loseSound.muted = false;
                muteToggleBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
                if (volumeSlider.value == 0) {
                    volumeSlider.value = 0.5;
                }
                setVolume(volumeSlider.value);
            } else {
                strikeMusic.muted = true; 
                winSound.muted = true;
                loseSound.muted = true;
                muteToggleBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
            }
        }

        // وظيفة عرض الرسائل (معدلة لتغيير التوهج)
        function showMessage(msg, isError = false, isWin = false) {
            messagesArea.textContent = msg;
            
            messagesArea.classList.remove('win-glow', 'lose-glow');

            if (isError) {
                messagesArea.classList.add('lose-glow');
                messagesArea.textContent += ' 😞'; // Add sad emoji for errors/losses
            } else if (isWin) {
                messagesArea.classList.add('win-glow');
                messagesArea.textContent += ' 🎉'; // Add party popper emoji for wins
            } else {
                messagesArea.style.boxShadow = '0 0 15px rgba(52, 152, 219, 0.7)'; 
                messagesArea.style.color = '#e0e0e0'; 
            }
        }

        // وظيفة تحديث عرض لوحة النتائج
        function updateScoreBoard() {
            currentRoundPointsDisplay.textContent = currentRoundPoints; 
            personalScoreDisplay.textContent = personalScore;
            highScoreDisplay.textContent = highScore;
            roundNumberDisplay.textContent = roundNumber;
            // ✅ تحديث عرض إحصائيات الضربات
            singleShotsUsedDisplay.textContent = singleShotsUsed;
            tripleShotsUsedDisplay.textContent = tripleShotsUsed;
            hammerShotsUsedDisplay.textContent = hammerShotsUsed;
            updateActionButtonsState(); 
        }

        // وظيفتان لتعطيل وتفعيل الأزرار
        function disableAllActionButtons() {
            singleShotButton.disabled = true;
            tripleShotButton.disabled = true;
            hammerShotButton.disabled = true;
        }

        function enableAllActionButtons() {
            singleShotButton.disabled = personalScore < SINGLE_SHOT_COST;
            singleShotButton.title = singleShotButton.disabled ? `تحتاج ${SINGLE_SHOT_COST} قطعة نقدية لاستخدام "ضربة فردية"` : '';

            tripleShotButton.disabled = personalScore < TRIPLE_SHOT_COST;
            tripleShotButton.title = tripleShotButton.disabled ? `تحتاج ${TRIPLE_SHOT_COST} قطعة نقدية لاستخدام "ضربة ثلاثية"` : '';

            hammerShotButton.disabled = personalScore < HAMMER_SHOT_COST;
            hammerShotButton.title = hammerShotButton.disabled ? `تحتاج ${HAMMER_SHOT_COST} قطعة نقدية لاستخدام "ضربة المطرقة"` : '';
        }


        // وظيفة لتحديث حالة أزرار "تلقائي" و "ضربة ثلاثية" و "ضربة المطرقة"
        function updateActionButtonsState() {
            singleShotButton.disabled = personalScore < SINGLE_SHOT_COST;
            singleShotButton.title = singleShotButton.disabled ? `تحتاج ${SINGLE_SHOT_COST} قطعة نقدية لاستخدام "ضربة فردية"` : '';

            tripleShotButton.disabled = personalScore < TRIPLE_SHOT_COST;
            tripleShotButton.title = tripleShotButton.disabled ? `تحتاج ${TRIPLE_SHOT_COST} قطعة نقدية لاستخدام "ضربة ثلاثية"` : '';

            hammerShotButton.disabled = personalScore < HAMMER_SHOT_COST;
            hammerShotButton.title = hammerShotButton.disabled ? `تحتاج ${HAMMER_SHOT_COST} قطعة نقدية لاستخدام "ضربة المطرقة"` : '';
        }

        // وظيفة إنشاء الصناديق
        function generateBoxes() {
            boxesContainer.innerHTML = '';
            boxes = [];
            
            let boxValues = [];

            for (let i = 0; i < num10PointsBoxes; i++) {
                boxValues.push({ type: 'positive', value: 10 });
            }
            for (let i = 0; i < num5PointsBoxes; i++) {
                boxValues.push({ type: 'positive', value: 5 });
            }
            for (let i = 0; i < num1PointsBoxes; i++) {
                boxValues.push({ type: 'positive', value: 1 });
            }

            for (let i = 0; i < numNegative5PointsBoxes; i++) {
                boxValues.push({ type: 'negative', value: -5 });
            }
            for (let i = 0; i < numNegative10PointsBoxes; i++) {
                boxValues.push({ type: 'negative', value: -10 });
            }

            const totalSpecifiedBoxes = boxValues.length;

            if (totalSpecifiedBoxes > numBoxes) {
                boxValues = boxValues.slice(0, numBoxes);
                showMessage(`تنبيه: مجموع الصناديق التي تم تحديدها (${totalSpecifiedBoxes}) يتجاوز العدد الكلي للصناديق (${numBoxes}). تم اختيار أول ${numBoxes} صندوق فقط.`, true);
            } else if (totalSpecifiedBoxes < numBoxes) {
                const remainingSlots = numBoxes - totalSpecifiedBoxes;
                // قم بملء الفراغات بصناديق +1 نقطة بشكل افتراضي
                for (let i = 0; i < remainingSlots; i++) {
                    boxValues.push({ type: 'positive', value: 1 });
                }
                showMessage(`تنبيه: تم ملء ${remainingSlots} صندوق إضافي بقيمة +1 قطعة نقدية لضمان العدد الكلي ${numBoxes}.`);
            }

            for (let i = boxValues.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [boxValues[i], boxValues[j]] = [boxValues[j], boxValues[i]];
            }

            for (let i = 0; i < numBoxes; i++) {
                const box = document.createElement('div');
                box.classList.add('box');
                box.dataset.index = i;
                box.dataset.type = boxValues[i].type; 
                box.dataset.value = boxValues[i].value;
                
                const randomGlowColor = glowColors[Math.floor(Math.random() * glowColors.length)];
                box.style.setProperty('--glow-color', randomGlowColor);

                const img = document.createElement('img');
                img.src = 'box_closed.png';
                img.alt = 'صندوق';
                img.classList.add('box-image');
                box.appendChild(img);
                
                boxesContainer.appendChild(box);
                boxes.push(box);
            }
            // ✅ تم إزالة منطق إنشاء/إعادة تعيين seekerImage من هنا
            // لأنه أصبح عنصرًا ثابتًا في HTML خارج boxesContainer
        }

        // وظيفة فتح الصندوق وتطبيق النقاط وإخفائه بعد 5 ثوانٍ
        function openBox(boxElement) {
            if (boxElement.classList.contains('opened')) {
                return; 
            }

            const value = parseInt(boxElement.dataset.value);
            const type = boxElement.dataset.type;

            boxElement.classList.add('opened');
            boxElement.textContent = (value > 0 ? '+' : '') + value; 

            if (value === 10) {
                boxElement.classList.add('positive-score-10');
            } else if (value === 5) {
                boxElement.classList.add('positive-score-5');
            } else if (value === 1) {
                boxElement.classList.add('positive-score-1');
            } else if (value === -5) {
                boxElement.classList.add('negative-score-5');
            } else if (value === -10) {
                boxElement.classList.add('negative-score-10');
            }

            currentRoundPoints += value;
            personalScore += value;

            if (personalScore > highScore) {
                highScore = personalScore;
            }

            updateScoreBoard();

            // إزالة الصندوق من مصفوفة `boxes` (إذا كنت تستخدمها لتتبع الصناديق المتبقية)
            // بما أننا نستخدم `boxesContainer.children` مباشرة الآن، قد لا يكون هذا ضروريًا
            // ولكن للحفاظ على الاتساق إذا كان هناك استخدام آخر للمصفوفة:
            const indexInBoxesArray = boxes.indexOf(boxElement);
            if (indexInBoxesArray > -1) {
                boxes.splice(indexInBoxesArray, 1);
            }

            // ✅ عرض رسالة النقاط فورًا بعد الفتح
            let scoreMessage = '';
            if (value > 0) {
                scoreMessage = `${username} حصل على +${value} قطعة نقدية!`; // تم تعديل الرسالة لتعكس اسم اللاعب
                showMessage(scoreMessage, false, true); // رسالة نجاح بلون أخضر
            } else if (value < 0) {
                scoreMessage = `${username} خسر ${Math.abs(value)} قطعة نقدية!`; // تم تعديل الرسالة لتعكس اسم اللاعب
                showMessage(scoreMessage, true, false); // رسالة خطأ بلون أحمر
            } else {
                scoreMessage = `${username} لم يجد قطعًا نقدية في هذا الصندوق.`; // تم تعديل الرسالة لتعكس اسم اللاعب
                showMessage(scoreMessage); // رسالة عادية
            }

            // ✅ يتم إزالة الصندوق من الـ DOM بعد فترة قصيرة
            setTimeout(() => {
                boxElement.style.transition = 'opacity 0.5s ease-out'; 
                boxElement.style.opacity = '0'; 
                setTimeout(() => {
                    if (boxElement.parentNode) {
                        boxElement.parentNode.removeChild(boxElement);
                    }
                }, 500); 
            }, 3000); 
        }

        // ✅ وظيفة جديدة لتحريك المؤشر إلى صندوق محدد
        function moveSeekerToBox(boxElement) {
            if (!boxElement) return;

            const boxRect = boxElement.getBoundingClientRect();
            const containerRect = boxesContainer.getBoundingClientRect();

            // حساب الموضع النسبي داخل الحاوية
            const targetX = boxRect.left - containerRect.left + (boxRect.width / 2);
            const targetY = boxRect.top - containerRect.top + (boxRect.height / 2);

            seekerImage.style.left = `${targetX}px`;
            seekerImage.style.top = `${targetY}px`;
            seekerImage.style.display = 'flex'; // Use flex to keep text centered
        }

        // ✅ وظيفة جديدة لإظهار التوهج المتسلسل
        function startSequentialGlow(availableBoxes, onComplete) {
            stopSequentialGlow(); // إيقاف أي توهج سابق
            let glowCount = 0;
            const totalGlows = Math.min(availableBoxes.length * 2, 30); // عدد مرات التوهج
            sequentialGlowIndex = 0;

            sequentialGlowInterval = setInterval(() => {
                if (glowCount >= totalGlows) {
                    stopSequentialGlow();
                    onComplete();
                    return;
                }

                // إزالة التوهج من الصندوق السابق
                if (sequentialGlowIndex > 0) {
                    availableBoxes[sequentialGlowIndex - 1].classList.remove('sequential-glow');
                } else if (availableBoxes.length > 0) {
                    availableBoxes[availableBoxes.length - 1].classList.remove('sequential-glow');
                }

                // إضافة التوهج للصندوق الحالي
                availableBoxes[sequentialGlowIndex].classList.add('sequential-glow');
                moveSeekerToBox(availableBoxes[sequentialGlowIndex]); // تحريك المؤشر مع التوهج

                sequentialGlowIndex = (sequentialGlowIndex + 1) % availableBoxes.length;
                glowCount++;
            }, 150); // سرعة التوهج
        }

        // ✅ وظيفة إيقاف التوهج المتسلسل
        function stopSequentialGlow() {
            clearInterval(sequentialGlowInterval);
            sequentialGlowInterval = null;
            const glowingBoxes = document.querySelectorAll('.box.sequential-glow');
            glowingBoxes.forEach(box => box.classList.remove('sequential-glow'));
        }

        // ✅ وظيفة اختيار الصناديق النهائية بعد التوهج
        function selectFinalBoxes(availableBoxes, count, onBoxSelected) {
            if (availableBoxes.length === 0) return;

            const finalBox = availableBoxes[sequentialGlowIndex]; // الصندوق الذي توقف عنده التوهج
            finalBox.classList.add('single-shot-final-glow');
            seekerImage.style.animation = 'finalSeekerPulse 0.5s infinite alternate'; // توهج المؤشر

            setTimeout(() => {
                onBoxSelected(finalBox);
                finalBox.classList.remove('single-shot-final-glow');
                seekerImage.style.animation = ''; // إيقاف توهج المؤشر
                seekerImage.style.display = 'none'; // إخفاء المؤشر
                enableAllActionButtons(); // إعادة تفعيل الأزرار
            }, 2000); // انتظر ثانيتين قبل فتح الصندوق
        }

        // وظيفة بدء جولة جديدة
        function startNewRound() {
            roundNumber++;
            currentRoundPoints = 0;
            showMessage(`الجولة ${roundNumber} بدأت! حظًا موفقًا يا ${username}!`);
            generateBoxes();
            updateScoreBoard();
            enableAllActionButtons();
        }

        // وظيفة بدء اللعبة
        async function startGame() {
            await fetchUsername(); // جلب اسم المستخدم من السيرفر
            startNewRound();
        }

        // وظيفة حفظ بيانات اللعبة (جاهزة للربط مع الباكند)
        function saveGameData() {
            const gameData = {
                username: username,
                personalScore: personalScore,
                highScore: highScore,
                roundNumber: roundNumber,
                singleShotsUsed: singleShotsUsed,
                tripleShotsUsed: tripleShotsUsed,
                hammerShotsUsed: hammerShotsUsed,
                date: new Date().toISOString()
            };
            // حفظ محلي (اختياري)
            localStorage.setItem(`gameData_${username}`, JSON.stringify(gameData));
            // حفظ في الباكند
            const token = localStorage.getItem('token'); // استخراج التوكن فقط
            if (token) {
                fetch('/api/users/save-game-score', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({
                        personalScore,
                        highScore,
                        roundNumber,
                        singleShotsUsed,
                        tripleShotsUsed,
                        hammerShotsUsed
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        console.log('تم حفظ النتيجة في قاعدة البيانات!', data.stats);
                    } else {
                        console.error('فشل حفظ النتيجة:', data.message);
                    }
                })
                .catch(err => {
                    console.error('خطأ في الاتصال بالسيرفر:', err);
                });
            } else {
                console.warn('لا يوجد توكن JWT، لن يتم حفظ النتائج في قاعدة البيانات!');
            }
        }

        // دالة لجلب اسم المستخدم من السيرفر
        async function fetchUsername() {
            const token = localStorage.getItem('token');
            if (!token) {
                showMessage('يجب تسجيل الدخول أولاً! سيتم تحويلك لصفحة الدخول...', true);
                disableAllActionButtons();
                setTimeout(() => { window.location.href = 'index.html'; }, 2000);
                throw new Error('لا يوجد توكن JWT');
            }
            try {
                const res = await fetch('/api/users/me', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (!res.ok) {
                    showMessage('فشل جلب بيانات المستخدم. سيتم تحويلك لصفحة الدخول...', true);
                    disableAllActionButtons();
                    setTimeout(() => { window.location.href = 'index.html'; }, 2000);
                    throw new Error('فشل جلب بيانات المستخدم');
                }
                const data = await res.json();
                if (!data.username) {
                    showMessage('المستخدم غير موجود في قاعدة البيانات! سيتم تحويلك لصفحة الدخول...', true);
                    disableAllActionButtons();
                    setTimeout(() => { window.location.href = 'index.html'; }, 2000);
                    throw new Error('المستخدم غير موجود');
                }
                username = data.username;
                usernameDisplay.textContent = username;
                enableAllActionButtons();
            } catch (err) {
                showMessage('حدث خطأ أثناء جلب اسم المستخدم! سيتم تحويلك لصفحة الدخول...', true);
                disableAllActionButtons();
                setTimeout(() => { window.location.href = 'index.html'; }, 2000);
                throw err;
            }
        }

        // مستمعو الأحداث
        document.addEventListener('DOMContentLoaded', () => {
            startGame();

            singleShotButton.addEventListener('click', () => {
                if (personalScore < SINGLE_SHOT_COST) {
                    showMessage('ليس لديك قطع نقدية كافية!', true);
                    return;
                }
                personalScore -= SINGLE_SHOT_COST;
                singleShotsUsed++;
                updateScoreBoard();
                disableAllActionButtons();
                showMessage('يتم تحديد صندوق عشوائي...');

                const availableBoxes = Array.from(boxesContainer.children).filter(b => !b.classList.contains('opened'));
                if (availableBoxes.length === 0) {
                    showMessage('لا توجد صناديق متبقية!', true);
                    enableAllActionButtons();
                    return;
                }

                startSequentialGlow(availableBoxes, () => {
                    selectFinalBoxes(availableBoxes, 1, (box) => {
                        playSound(winSound, 'خطأ في تشغيل صوت الفوز');
                        openBox(box);
                    });
                });
            });

            tripleShotButton.addEventListener('click', () => {
                if (personalScore < TRIPLE_SHOT_COST) {
                    showMessage('ليس لديك قطع نقدية كافية!', true);
                    return;
                }
                personalScore -= TRIPLE_SHOT_COST;
                tripleShotsUsed++;
                updateScoreBoard();
                disableAllActionButtons();
                showMessage('يتم تحديد 3 صناديق عشوائية...');

                const availableBoxes = Array.from(boxesContainer.children).filter(b => !b.classList.contains('opened'));
                if (availableBoxes.length < 3) {
                    showMessage('لا توجد صناديق كافية لهذه الضربة!', true);
                    personalScore += TRIPLE_SHOT_COST; // استرجاع المبلغ
                    tripleShotsUsed--;
                    updateScoreBoard();
                    enableAllActionButtons();
                    return;
                }

                startSequentialGlow(availableBoxes, () => {
                    // تحديد 3 صناديق فريدة
                    const finalIndices = new Set();
                    while(finalIndices.size < 3) {
                        const randomIndex = Math.floor(Math.random() * availableBoxes.length);
                        finalIndices.add(randomIndex);
                    }

                    let delay = 0;
                    finalIndices.forEach(index => {
                        const box = availableBoxes[index];
                        setTimeout(() => {
                            moveSeekerToBox(box);
                            box.classList.add('single-shot-final-glow');
                            setTimeout(() => {
                                playSound(winSound, 'خطأ في تشغيل صوت الفوز');
                                openBox(box);
                                box.classList.remove('single-shot-final-glow');
                            }, 1000);
                        }, delay);
                        delay += 1200;
                    });

                    setTimeout(() => {
                        seekerImage.style.display = 'none';
                        enableAllActionButtons();
                    }, delay);
                });
            });

            hammerShotButton.addEventListener('click', () => {
                if (personalScore < HAMMER_SHOT_COST) {
                    showMessage('ليس لديك قطع نقدية كافية!', true);
                    return;
                }
                personalScore -= HAMMER_SHOT_COST;
                hammerShotsUsed++;
                updateScoreBoard();
                disableAllActionButtons();
                showMessage('ضربة المطرقة! يتم فتح العديد من الصناديق...');

                const availableBoxes = Array.from(boxesContainer.children).filter(b => !b.classList.contains('opened'));
                const boxesToOpenCount = Math.min(availableBoxes.length, HAMMER_SHOT_BOXES);

                if (boxesToOpenCount === 0) {
                    showMessage('لا توجد صناديق متبقية!', true);
                    personalScore += HAMMER_SHOT_COST;
                    hammerShotsUsed--;
                    updateScoreBoard();
                    enableAllActionButtons();
                    return;
                }

                // خلط الصناديق المتاحة
                for (let i = availableBoxes.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [availableBoxes[i], availableBoxes[j]] = [availableBoxes[j], availableBoxes[i]];
                }

                const boxesToOpen = availableBoxes.slice(0, boxesToOpenCount);
                let delay = 0;
                boxesToOpen.forEach(box => {
                    setTimeout(() => {
                        moveSeekerToBox(box);
                        box.classList.add('single-shot-final-glow');
                        setTimeout(() => {
                            playSound(winSound, 'خطأ في تشغيل صوت الفوز');
                            openBox(box);
                            box.classList.remove('single-shot-final-glow');
                        }, 500);
                    }, delay);
                    delay += 200; // فتح سريع ومتتالي
                });

                setTimeout(() => {
                    seekerImage.style.display = 'none';
                    enableAllActionButtons();
                }, delay + 500);
            });

            logoutButton.addEventListener('click', () => {
                saveGameData();
                localStorage.removeItem('username');
                window.location.href = 'index.html';
            });

            volumeSlider.addEventListener('input', updateVolumeFromSlider);
            increaseVolumeBtn.addEventListener('click', increaseVolume);
            decreaseVolumeBtn.addEventListener('click', decreaseVolume);
            muteToggleBtn.addEventListener('click', toggleMute);

            window.addEventListener('beforeunload', saveGameData);
        });

    </script>
</body>
</html>