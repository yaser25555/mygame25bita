// ??? ????? ?????? UTF-8 ???? BOM
// ??? ?????? ???????
// BACKEND_URL ???? ?? navigation.js

// ??????? ??????
let gameState = {
    isPlaying: false,
    score: 0,
    level: 1,
    lives: 3,
    isMuted: false
};

// ???? ????? ?????
function playSound(soundName) {
    if (gameState.isMuted) return;
    
    try {
        const sounds = {
            buttonClick: document.getElementById('buttonClick'),
            win: document.getElementById('winSound'),
            lose: document.getElementById('loseSound'),
            hammer: document.getElementById('hammerSound'),
            single: document.getElementById('singleSound'),
            triple: document.getElementById('tripleSound')
        };
        
        const sound = sounds[soundName];
        if (sound) {
            sound.currentTime = 0;
            sound.play().catch(() => {});
        }
    } catch (error) {
        console.log('?? ???? ????? ?????:', soundName);
    }
}

// ???? ???/????? ??? ?????
function toggleMute() {
    gameState.isMuted = !gameState.isMuted;
    const muteButton = document.getElementById('mute-button');
    if (muteButton) {
        muteButton.textContent = gameState.isMuted ? '??' : '??';
    }
    console.log(gameState.isMuted ? '?? ?? ??? ?????' : '?? ?? ????? ??? ?????');
}

// ????? ?????? ???????? ?? ??????
function updateUserDataInGame() {
    console.log('?? ????? ?????? ???????? ?? ??????...');
    
    const token = localStorage.getItem('token');
    if (!token) {
        console.log('? ?? ???? token? ?? ???? ????? ????????');
        return;
    }
    
    fetch(`${BACKEND_URL}/api/users/me`, {
        headers: { 'Authorization': `Bearer ${token}` }
    })
    .then(response => response.json())
    .then(userData => {
        console.log('?? ??? ?????? ???????? ?? ??????:', userData);
        
        // ????? ??? ????????
        const usernameElement = document.getElementById('game-username');
        if (usernameElement) {
            usernameElement.textContent = userData.username || '??????';
        }
        
        // ????? ???? ????????
        const userIdElement = document.getElementById('user-id-display');
        if (userIdElement) {
            console.log('?? ????? ?? ???? ???????? ?? ??????:', userData);
            console.log('?? userData.userId:', userData.userId);
            console.log('?? userData._id:', userData._id);
            
            if (userData.userId) {
                userIdElement.textContent = `ID: ${userData.userId}`;
                console.log('? ?? ????? ???? ???????? ?? ??????:', userData.userId);
            } else if (userData._id) {
                userIdElement.textContent = `ID: ${userData._id}`;
                console.log('? ?? ????? ???? ???????? ?? ?????? (?? _id):', userData._id);
            } else {
                userIdElement.textContent = 'ID: ??? ????';
                console.log('?? ???? ???????? ??? ????? ?? ?????? ??????');
            }
        } else {
            console.log('? ???? user-id-display ??? ????? ?? ???? ??????');
        }
        
        // ????? ??????
        const balanceElement = document.getElementById('game-balance');
        if (balanceElement) {
            const balance = userData.balance || userData.stats?.score || 0;
            balanceElement.textContent = balance.toLocaleString();
        }
        
        // ????? ??????
        const pearlsElement = document.getElementById('game-pearls');
        if (pearlsElement) {
            const pearls = userData.pearls || userData.stats?.pearls || 0;
            pearlsElement.textContent = pearls.toLocaleString();
        }
        
        // ??? ?????? ???????? ?? ???????
        window.currentUser = userData;
        
        console.log('? ?? ????? ?????? ?????? ?????');
    })
    .catch(error => {
        console.error('? ??? ?? ????? ?????? ??????:', error);
    });
}

// ???? ??? ??????
function startGame() {
    console.log('?? ??? ??????...');
    
    if (!window.currentUser) {
        showMessage('???? ????? ?????? ?????', 'error');
        return;
    }
    
    gameState.isPlaying = true;
    gameState.score = 0;
    gameState.lives = 3;
    
    // ????? ???? ???????
    const startScreen = document.getElementById('start-screen');
    if (startScreen) {
        startScreen.style.display = 'none';
    }
    
    // ????? ????? ??????
    const gameArea = document.getElementById('game-area');
    if (gameArea) {
        gameArea.style.display = 'block';
    }
    
    // ??? ???? ??????
    gameLoop();
    
    console.log('? ?? ??? ?????? ?????');
}

// ???? ????? ??????
function stopGame() {
    console.log('?? ????? ??????...');
    
    gameState.isPlaying = false;
    
    // ????? ???? ???????
    showGameResults();
    
    console.log('? ?? ????? ??????');
}

// ???? ??? ????? ??????
function showGameResults() {
    const resultsScreen = document.getElementById('results-screen');
    if (resultsScreen) {
        // ????? ???????
        const finalScoreElement = document.getElementById('final-score');
        if (finalScoreElement) {
            finalScoreElement.textContent = gameState.score.toLocaleString();
        }
        
        // ????? ??????
        resultsScreen.style.display = 'block';
    }
}

// ???? ????? ????? ??????
function restartGame() {
    console.log('?? ????? ????? ??????...');
    
    // ????? ???? ???????
    const resultsScreen = document.getElementById('results-screen');
    if (resultsScreen) {
        resultsScreen.style.display = 'none';
    }
    
    // ????? ????? ???? ??????
    gameState.score = 0;
    gameState.lives = 3;
    gameState.level = 1;
    
    // ??? ?????? ?? ????
    startGame();
}

// ???? ?????? ??????? ????????
function backToMainMenu() {
    console.log('?? ?????? ??????? ????????...');
    
    // ????? ??????
    gameState.isPlaying = false;
    
    // ????? ???? ????? ??????
    const screens = ['start-screen', 'game-area', 'results-screen'];
    screens.forEach(screenId => {
        const screen = document.getElementById(screenId);
        if (screen) {
            screen.style.display = 'none';
        }
    });
    
    // ????? ???? ???????
    const startScreen = document.getElementById('start-screen');
    if (startScreen) {
        startScreen.style.display = 'block';
    }
    
    console.log('? ?? ?????? ??????? ????????');
}

// ???? ?????? ????????
function gameLoop() {
    if (!gameState.isPlaying) return;
    
    // ????? ??????
    updateGame();
    
    // ??? ??????
    drawGame();
    
    // ??????? ??????
    requestAnimationFrame(gameLoop);
}

// ???? ????? ??????
function updateGame() {
    // ??? ??? ????? ???? ??????
    // ??? ???? ????????? ?????????? ???
}

// ???? ??? ??????
function drawGame() {
    // ??? ??? ??? ????? ??????
    // ??? ??????? ???????? ???????? ???
}

// ???? ????? ????
function addScore(points) {
    gameState.score += points;
    
    // ????? ??? ??????
    const scoreElement = document.getElementById('current-score');
    if (scoreElement) {
        scoreElement.textContent = gameState.score.toLocaleString();
    }
    
    console.log(`? ?? ????? ${points} ????. ???????: ${gameState.score}`);
}

// ???? ????? ????
function loseLife() {
    gameState.lives--;
    
    // ????? ??? ??????
    const livesElement = document.getElementById('current-lives');
    if (livesElement) {
        livesElement.textContent = gameState.lives;
    }
    
    console.log(`?? ???? ????. ???????: ${gameState.lives}`);
    
    if (gameState.lives <= 0) {
        gameOver();
    }
}

// ???? ?????? ??????
function gameOver() {
    console.log('?? ????? ??????');
    
    playSound('lose');
    stopGame();
    
    // ??? ??????? ?? ??????
    saveGameResult();
}

// ???? ??? ????? ??????
async function saveGameResult() {
    const token = localStorage.getItem('token');
    if (!token) return;
    
    try {
        const response = await fetch(`${BACKEND_URL}/api/users/update-score`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                score: gameState.score,
                level: gameState.level
            })
        });
        
        if (response.ok) {
            console.log('? ?? ??? ??????? ?????');
            // ????? ?????? ????????
            updateUserDataInGame();
        } else {
            console.error('? ??? ?? ??? ???????');
        }
    } catch (error) {
        console.error('? ??? ?? ??? ???????:', error);
    }
}

// ???? ??? ?????
function showMessage(message, type = 'info') {
    console.log(`[${type.toUpperCase()}] ${message}`);
    
    // ???? ????? ??? ?????? ????? ????? ???? ??????
    const messageContainer = document.getElementById('game-message');
    if (messageContainer) {
        messageContainer.textContent = message;
        messageContainer.className = `message ${type}`;
        messageContainer.style.display = 'block';
        
        setTimeout(() => {
            messageContainer.style.display = 'none';
        }, 3000);
    }
}

// ????? ????? ??????
function setupGameEvents() {
    // ?? ??? ??????
    const startButton = document.getElementById('start-button');
    if (startButton) {
        startButton.addEventListener('click', () => {
            playSound('buttonClick');
            startGame();
        });
    }
    
    // ?? ????? ???????
    const restartButton = document.getElementById('restart-button');
    if (restartButton) {
        restartButton.addEventListener('click', () => {
            playSound('buttonClick');
            restartGame();
        });
    }
    
    // ?? ?????? ???????
    const menuButton = document.getElementById('menu-button');
    if (menuButton) {
        menuButton.addEventListener('click', () => {
            playSound('buttonClick');
            backToMainMenu();
        });
    }
    
    // ?? ??? ?????
    const muteButton = document.getElementById('mute-button');
    if (muteButton) {
        muteButton.addEventListener('click', () => {
            toggleMute();
        });
    }
    
    console.log('? ?? ????? ????? ??????');
}

// ????? ?????? ????????? ?????
window.playSound = playSound;
window.toggleMute = toggleMute;
window.startGame = startGame;
window.stopGame = stopGame;
window.restartGame = restartGame;
window.backToMainMenu = backToMainMenu;
window.addScore = addScore;
window.loseLife = loseLife;
window.showMessage = showMessage;

// ????? ?????? ??? ????? ??????
document.addEventListener('DOMContentLoaded', () => {
    console.log('?? ????? ???? ??????...');
    
    // ????? ?????? ????????
    updateUserDataInGame();
    
    // ????? ????? ??????
    setupGameEvents();
    
    console.log('? ?? ????? ???? ?????? ?????');
}); 
