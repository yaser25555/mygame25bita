<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>INFINITY BOX VOICEBOOM</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri&family=Scheherazade+New:wght@400;700&family=Noto+Naskh+Arabic:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="login-styles.css">
</head>
<body>
    <div class="container">
        <img src="images/logo.png" alt="Voice Boom Logo" class="logo">
        <h1>INFINITY BOX VOICEBOOM</h1>

        <div id="admin-choice-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <h3>أهلاً بك أيها المشرف</h3>
                <p>إلى أين تريد الذهاب؟</p>
                <button id="go-to-game-btn" class="btn">الدخول للعبة</button>
                <button id="go-to-admin-btn" class="btn">الدخول للوحة التحكم</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-button active" id="login-tab">تسجيل الدخول</button>
            <button class="tab-button" id="register-tab">تسجيل</button>
            <button class="tab-button" id="contact-tab">للاستفسار وشحن العملات</button>
        </div>

        <div id="message-box" class="message-box"></div>

        <!-- قسم تسجيل الدخول -->
        <div id="login-section" class="content-section active">
            <div class="form-group">
                <label for="login-username">اسم المستخدم / البريد الإلكتروني:</label>
                <input type="text" id="login-username" placeholder="أدخل اسم المستخدم أو البريد الإلكتروني" required>
            </div>
            <div class="form-group">
                <label for="login-password">كلمة المرور:</label>
                <input type="password" id="login-password" placeholder="أدخل كلمة المرور" required>
            </div>
            <button id="login-button" class="btn">
                <span class="loading-spinner"></span>
                <span class="btn-text">تسجيل الدخول</span>
            </button>
        </div>

        <!-- قسم التسجيل -->
        <div id="register-section" class="content-section">
            <div class="form-group">
                <label for="register-username">اسم المستخدم:</label>
                <input type="text" id="register-username" placeholder="اختر اسم مستخدم" required>
            </div>
            <div class="form-group">
                <label for="register-email">البريد الإلكتروني:</label>
                <input type="email" id="register-email" placeholder="أدخل بريدك الإلكتروني" required>
            </div>
            <div class="form-group">
                <label for="register-password">كلمة المرور:</label>
                <input type="password" id="register-password" placeholder="اختر كلمة مرور" required>
            </div>
            <button id="register-button" class="btn">
                <span class="loading-spinner"></span>
                <span class="btn-text">تسجيل</span>
            </button>
        </div>

        <!-- قسم محتوى التطبيقات (يظهر عند النقر على تبويب التطبيقات) -->
        <!-- تم إزالة هذا القسم بالكامل -->

        <!-- قسم محتوى التواصل معنا (يظهر عند النقر على تبويب التواصل) -->
        <div id="contact-section-content" class="content-section">
            <h3>للاستفسار وشحن العملات</h3>
            <p>يسعدنا تلقي استفساراتكم ومساعدتكم في شحن العملات. لا تترددوا في الاتصال بنا.</p>
            <div class="contact-info-item">
                <i class="fas fa-envelope"></i> البريد الإلكتروني: <a href="mailto:YASER.HAROON79@GMAIL.COM">YASER.HAROON79@GMAIL.COM</a>
            </div>
            <div class="contact-info-item">
                <i class="fab fa-whatsapp"></i> رقم واتساب: <a href="https://wa.me/966554593007">00966554593007</a>
            </div>
        </div>
    </div>

    <script>
        const BACKEND_URL = "http://localhost:3000"; // Use your actual backend URL

        document.addEventListener('DOMContentLoaded', () => {
            const loginTab = document.getElementById('login-tab');
            const registerTab = document.getElementById('register-tab');
            const instructionsTab = document.getElementById('instructions-tab');
            // تم إزالة appsTab من هنا
            const contactTab = document.getElementById('contact-tab');

            const loginSection = document.getElementById('login-section');
            const registerSection = document.getElementById('register-section');
            const instructionsSectionContent = document.getElementById('instructions-section-content');
            // تم إزالة appsSectionContent من هنا
            const contactSectionContent = document.getElementById('contact-section-content');

            const loginUsernameInput = document.getElementById('login-username');
            const loginPasswordInput = document.getElementById('login-password');
            const loginButton = document.getElementById('login-button');

            const registerUsernameInput = document.getElementById('register-username');
            const registerEmailInput = document.getElementById('register-email');
            const registerPasswordInput = document.getElementById('register-password');
            const registerButton = document.getElementById('register-button');

            const messageBox = document.getElementById('message-box');
            const getTipButton = document.getElementById('get-tip-button');
            const gameTipOutput = document.getElementById('game-tip-output');

            const adminChoiceModal = document.getElementById('admin-choice-modal');
            const goToGameBtn = document.getElementById('go-to-game-btn');
            const goToAdminBtn = document.getElementById('go-to-admin-btn');


            const baseURL = 'https://mygame25bita.onrender.com'; // PRODUCTION: Point to the Render backend URL

            // Force hide admin modal on page load
            if (adminChoiceModal) {
                adminChoiceModal.style.display = 'none';
            }

            function showMessage(message, isError = false) {
                messageBox.textContent = message;
                messageBox.classList.remove('success', 'error');
                if (isError) {
                    messageBox.classList.add('error');
                } else {
                    messageBox.classList.add('success');
                }
                messageBox.classList.add('show');
                setTimeout(() => {
                    messageBox.classList.remove('show');
                }, 5000);
            }

            function setButtonLoading(button, isLoading) {
                button.disabled = isLoading;
                if (isLoading) {
                    button.classList.add('loading');
                } else {
                    button.classList.remove('loading');
                }
            }

            function switchTab(activeTab) {
                // Hide all sections and remove active class from all tabs
                [loginTab, registerTab, instructionsTab, contactTab].forEach(tab => {
                    if (tab) tab.classList.remove('active');
                });
                [loginSection, registerSection, instructionsSectionContent, contactSectionContent].forEach(section => {
                    if (section) section.classList.remove('active');
                });

                // Show the correct section based on the active tab
                if (activeTab) {
                    activeTab.classList.add('active');
                    const targetSectionId = activeTab.id.replace('-tab', '-section');
                    const targetSection = document.getElementById(targetSectionId) || document.getElementById(targetSectionId + '-content');
                    if (targetSection) {
                        targetSection.classList.add('active');
                    }
                }
                messageBox.classList.remove('show');
            }

            async function handleLogin() {
                const username = loginUsernameInput.value.trim();
                const password = loginPasswordInput.value.trim();

                if (!username || !password) {
                    showMessage('الرجاء إدخال اسم المستخدم/البريد الإلكتروني وكلمة المرور.', true);
                    return;
                }

                setButtonLoading(loginButton, true);

                try {
                    const response = await fetch(`${baseURL}/api/auth/login`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ username, password }),
                    });

                    const data = await response.json();

                    if (response.ok) {
                        localStorage.setItem('token', data.token);
                        localStorage.setItem('isAdmin', data.isAdmin ? 'true' : 'false');
                        localStorage.setItem('username', data.username);
                        showMessage('تم تسجيل الدخول بنجاح!', false);
                        
                        setTimeout(() => {
                            if (data.isAdmin) {
                                adminChoiceModal.style.display = 'flex';
                            } else {
                                window.location.href = 'game.html';
                            }
                        }, 500); // 0.5 second delay

                    } else {
                        showMessage(`فشل تسجيل الدخول: ${data.message || 'خطأ غير معروف'}`, true);
                    }
                } catch (error) {
                    console.error('خطأ في الاتصال بالخادم:', error);
                    showMessage('خطأ في الاتصال بالخادم. يرجى المحاولة لاحقًا.', true);
                } finally {
                    setButtonLoading(loginButton, false);
                }
            }

            async function handleRegister() {
                const username = registerUsernameInput.value.trim();
                const email = registerEmailInput.value.trim();
                const password = registerPasswordInput.value.trim();

                if (!username || !email || !password) {
                    showMessage('الرجاء تعبئة جميع الحقول للتسجيل.', true);
                    return;
                }

                if (!/\S+@\S+\.\S+/.test(email)) {
                    showMessage('الرجاء إدخال بريد إلكتروني صالح.', true);
                    return;
                }

                setButtonLoading(registerButton, true);

                try {
                    const response = await fetch(`${baseURL}/api/auth/register`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, email, password }),
                    });

                    const data = await response.json();

                    if (response.ok) {
                        showMessage('تم التسجيل بنجاح! يمكنك الآن تسجيل الدخول.', false);
                        switchTab(loginTab);
                        loginUsernameInput.value = username;
                        loginPasswordInput.value = '';
                    } else {
                        showMessage(`فشل التسجيل: ${data.message || 'خطأ غير معروف'}`, true);
                    }
                } catch (error) {
                    console.error('خطأ في الاتصال بالخادم:', error);
                    showMessage('خطأ في الاتصال بالخادم. يرجى المحاولة لاحقًا.', true);
                } finally {
                    setButtonLoading(registerButton, false);
                }
            }

            // ----------------------------------------------------
            // ميزة: الحصول على نصيحة للعبة باستخدام Gemini API
            // ----------------------------------------------------
            async function getMagicGameTip() {
                setButtonLoading(getTipButton, true);
                gameTipOutput.textContent = 'جاري توليد نصيحة سحرية...';
                
                try {
                    const prompt = "Please provide a short, single-sentence, motivational, or strategic tip for playing a game called 'INFINITY BOX VOICEBOOM'. The game involves opening mysterious boxes to get points, but some boxes might reduce points. Players can collect points at any time or proceed to the next round. The game also has special powers. The tip should be in Arabic.";
                    
                    let chatHistory = [];
                    chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                    const payload = { contents: chatHistory };
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        gameTipOutput.textContent = text;
                    } else {
                        gameTipOutput.textContent = 'عذراً، لم أتمكن من توليد نصيحة الآن. يرجى المحاولة لاحقاً.';
                        console.error('Gemini API returned an unexpected response structure:', result);
                    }
                } catch (error) {
                    console.error('Error calling Gemini API:', error);
                    gameTipOutput.textContent = 'حدث خطأ أثناء الاتصال بالذكاء الاصطناعي. يرجى المحاولة لاحقاً.';
                } finally {
                    setButtonLoading(getTipButton, false);
                }
            }


            // حدث النقر على ألسنة التبويب
            if (loginTab) loginTab.addEventListener('click', () => switchTab(loginTab));
            if (registerTab) registerTab.addEventListener('click', () => switchTab(registerTab));
            if (instructionsTab) instructionsTab.addEventListener('click', () => switchTab(instructionsTab));
            // تم إزالة حدث النقر لـ appsTab
            if (contactTab) contactTab.addEventListener('click', () => switchTab(contactTab));

            // أحداث النقر على الأزرار
            if (loginButton) {
                loginButton.addEventListener('click', handleLogin);
            }
            if (registerButton) {
                registerButton.addEventListener('click', handleRegister);
            }
            if (getTipButton) {
                getTipButton.addEventListener('click', getMagicGameTip);
            }

            if(goToGameBtn) {
                goToGameBtn.addEventListener('click', () => {
                    window.location.href = 'game.html';
                });
            }
    
            if(goToAdminBtn) {
                goToAdminBtn.addEventListener('click', () => {
                    window.location.href = 'admin.html';
                });
            }

            // السماح بالضغط على Enter لإرسال النماذج
            loginUsernameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') loginButton.click();
            });
            loginPasswordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') loginButton.click();
            });
            registerUsernameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') registerButton.click();
            });
            registerEmailInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') registerButton.click();
            });
            registerPasswordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') registerButton.click();
            });

            // إخفاء زر تسجيل دخول المسؤول القديم إذا كان موجوداً
            const oldAdminLoginButton = document.getElementById('adminLoginButton');
            if (oldAdminLoginButton) {
                oldAdminLoginButton.style.display = 'none';
            }

            // افتراضيًا, إظهار قسم تسجيل الدخول عند تحميل الصفحة
            switchTab(loginTab);
        });
    </script>
</body>
</html>