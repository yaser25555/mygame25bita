<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoiceBoom Game</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Amiri&family=Scheherazade+New:wght@400;700&family=Noto+Naskh+Arabic:wght@400;700&display=swap" rel="stylesheet">
    <!-- Agora SDK for Voice Chat -->
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.19.3.js"></script>
    <!-- Voice Chat Manager -->
    <script src="voice-chat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Naskh Arabic', sans-serif;
            color: #E0E0E0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            padding: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
            overflow-x: hidden;
            position: relative;
            z-index: 0;

            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-image: url('background_image.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-blend-mode: overlay;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.8) 0%, rgba(118, 75, 162, 0.8) 100%);
            z-index: -1;
        }

        .main-content {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            width: 100%;
            margin-top: 20px;
            padding-right: 420px; /* Space for the fixed sidebar */
        }

        .right-panel {
            position: fixed;
            top: 20px;
            right: 0;
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 380px;
            z-index: 50;
            padding: 0 20px;
        }

        .player-info {
            position: relative;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 20px 25px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            border-radius: 35px;
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            min-width: 320px;
        }

        .player-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }

        .player-details {
            display: flex;
            flex-direction: column;
            line-height: 1.4;
        }

        .player-details p {
            margin: 0;
            font-size: 1.1em;
            white-space: nowrap;
            font-weight: 600;
        }

        .player-details p:first-child {
            font-weight: bold;
            font-size: 1.3em;
            color: #FFD700;
        }

        .player-actions {
            display: flex;
            gap: 12px;
        }

        .player-actions button {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.1) 100%);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            font-size: 1.3em;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            backdrop-filter: blur(10px);
        }

        .player-actions button:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.4) 0%, rgba(255, 255, 255, 0.2) 100%);
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.3);
        }

        .game-container {
            width: 100%;
            max-width: 900px;
            position: relative;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-radius: 30px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            padding: 30px;
            min-height: 700px;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            z-index: 5;
        }

        .game-container:hover {
            box-shadow: 
                0 25px 80px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .message-area {
            margin-bottom: 30px;
            font-size: 1.4em;
            font-weight: bold;
            min-height: 40px;
            text-align: center;
            padding: 15px 20px;
            border-radius: 15px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            z-index: 6;
        }

        .message-area.success { 
            color: #4ade80; 
            background: linear-gradient(135deg, rgba(74, 222, 128, 0.2) 0%, rgba(74, 222, 128, 0.1) 100%);
            border-color: rgba(74, 222, 128, 0.3);
            box-shadow: 0 0 20px rgba(74, 222, 128, 0.3);
        }
        
        .message-area.error { 
            color: #f87171; 
            background: linear-gradient(135deg, rgba(248, 113, 113, 0.2) 0%, rgba(248, 113, 113, 0.1) 100%);
            border-color: rgba(248, 113, 113, 0.3);
            box-shadow: 0 0 20px rgba(248, 113, 113, 0.3);
        }
        
        .message-area.info { 
            color: #60a5fa; 
            background: linear-gradient(135deg, rgba(96, 165, 250, 0.2) 0%, rgba(96, 165, 250, 0.1) 100%);
            border-color: rgba(96, 165, 250, 0.3);
            box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
        }

        .boxes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 20px;
            margin: 30px 0;
            position: relative;
            padding: 20px;
            z-index: 7;
            flex-grow: 1;
        }

        .box {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            border: 3px solid #d97706;
            border-radius: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            background-image: url('box_closed.png');
            background-size: cover;
            background-position: center;
            box-shadow: 
                0 8px 25px rgba(0, 0, 0, 0.3),
                inset 0 2px 4px rgba(255, 255, 255, 0.3);
            overflow: hidden;
            animation: floatAndGlow 4s infinite ease-in-out;
        }

        .box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, transparent 50%, rgba(0, 0, 0, 0.1) 100%);
            border-radius: 17px;
            pointer-events: none;
        }

        @keyframes floatAndGlow {
            0% { 
                transform: translateY(0px) scale(1); 
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3), inset 0 2px 4px rgba(255, 255, 255, 0.3);
            }
            25% { 
                transform: translateY(-8px) scale(1.03); 
                box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4), inset 0 2px 4px rgba(255, 255, 255, 0.3);
            }
            50% { 
                transform: translateY(0px) scale(1); 
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3), inset 0 2px 4px rgba(255, 255, 255, 0.3);
            }
            75% { 
                transform: translateY(8px) scale(1.03); 
                box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4), inset 0 2px 4px rgba(255, 255, 255, 0.3);
            }
            100% { 
                transform: translateY(0px) scale(1); 
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3), inset 0 2px 4px rgba(255, 255, 255, 0.3);
            }
        }

        .box:hover:not(.opened) {
            transform: translateY(-12px) scale(1.07);
            animation: none;
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.5),
                inset 0 2px 4px rgba(255, 255, 255, 0.3);
        }

        .box.opened {
            background-image: none;
            transform: scale(0.95);
            animation: none !important;
            cursor: default;
        }

        /* Styles for opened boxes with different results */
        .box.opened.win {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: 3px solid #047857;
            box-shadow: 0 0 20px 8px rgba(16, 185, 129, 0.6);
        }

        .box.opened.lose {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border: 3px solid #b91c1c;
            box-shadow: 0 0 20px 8px rgba(239, 68, 68, 0.6);
        }

        .box.opened.neutral {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            border: 3px solid #374151;
            box-shadow: 0 0 20px 8px rgba(107, 114, 128, 0.6);
        }

        .box-content {
            text-align: center;
            z-index: 2;
            position: relative;
        }

        .box-text {
            font-size: 1.3em;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .coin-icon {
            width: 90px;
            height: 60px;
            background-image: url('coin.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            display: none;
            margin: 8px auto 0;
            animation: coinGlow 2s infinite alternate;
            filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.8));
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 30px;
            z-index: 8;
        }

        .bet-button {
            padding: 18px 35px;
            font-size: 1.3em;
            font-weight: bold;
            cursor: pointer;
            border: none;
            border-radius: 15px;
            color: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 200px;
            justify-content: center;
        }

        .bet-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .bet-button:hover::before {
            left: 100%;
        }

        .bet-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .bet-button:active {
            transform: translateY(-1px);
        }

        .bet-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .bet-button:disabled:hover {
            transform: none !important;
            box-shadow: none !important;
        }

        #single-shot-button { 
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }
        
        #single-shot-button:hover {
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.6);
        }
        
        #triple-shot-button { 
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
        }
        
        #triple-shot-button:hover {
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.6);
        }
        
        #hammer-shot-button { 
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }
        
        #hammer-shot-button:hover {
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.6);
        }

        #seeker-hero {
            position: absolute;
            width: 90px;
            height: 90px;
            background-image: url('hero.png');
            background-size: contain;
            background-repeat: no-repeat;
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translate(-50%, -50%);
            z-index: 20;
            display: none;
            filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.8));
        }

        @keyframes coinGlow {
            0% {
                filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.8)) brightness(1);
                transform: scale(1);
            }
            50% {
                filter: drop-shadow(0 0 20px rgba(255, 215, 0, 1)) brightness(1.2);
                transform: scale(1.05);
            }
            100% {
                filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.8)) brightness(1);
                transform: scale(1);
            }
        }

        @keyframes finalSeekerPulse {
            0% { 
                transform: translate(-50%, -50%) scale(1);
                filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.8));
            }
            50% {
                transform: translate(-50%, -50%) scale(1.3);
                filter: drop-shadow(0 0 25px rgba(255, 255, 255, 1));
            }
            100% { 
                transform: translate(-50%, -50%) scale(1);
                filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.8));
            }
        }

        @keyframes sequentialGlow {
            0% { 
                box-shadow: 0 0 20px 10px rgba(255, 255, 0, 0.6);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 30px 15px rgba(255, 255, 0, 0.9);
                transform: scale(1.1);
            }
            100% { 
                box-shadow: 0 0 20px 10px rgba(255, 255, 0, 0.6);
                transform: scale(1);
            }
        }

        .sequential-glow {
            animation: sequentialGlow 0.6s ease-in-out;
        }

        @keyframes finalGlow {
            0% { 
                box-shadow: 0 0 20px 10px rgba(0, 255, 0, 0.7);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 40px 20px rgba(0, 255, 0, 1);
                transform: scale(1.15);
            }
            100% { 
                box-shadow: 0 0 20px 10px rgba(0, 255, 0, 0.7);
                transform: scale(1);
            }
        }

        .single-shot-final-glow {
            animation: finalGlow 1.2s infinite alternate;
        }

        #loading-indicator {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.8) 0%, rgba(0, 0, 0, 0.6) 100%);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.2em;
            font-weight: bold;
            z-index: 1000;
            display: none;
            backdrop-filter: blur(10px);
        }

        /* Chat Window Styles */
        .chat-container {
            position: sticky;
            top: 120px;
            width: 380px;
            height: 600px;
            flex-shrink: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
            backdrop-filter: blur(25px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            z-index: 50;
            transition: all 0.3s ease;
        }

        .chat-container.collapsed {
            width: 70px;
            overflow: hidden;
        }

        .chat-container.collapsed .chat-messages,
        .chat-container.collapsed .chat-input-container,
        .chat-container.collapsed .chat-header h3,
        .chat-container.collapsed #voiceChatBtn,
        .chat-container.collapsed #chatMuteBtn {
            display: none;
        }

        .chat-container.collapsed .chat-header {
            justify-content: center;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.3) 0%, rgba(52, 152, 219, 0.1) 100%);
            border-radius: 18px 18px 0 0;
        }

        .chat-header h3 {
            margin: 0;
            color: #fff;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chat-control-btn,
        .chat-toggle-btn {
            border: none;
            color: #fff;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
            box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.2), 0 2px 8px rgba(0, 0, 0, 0.4);
        }

        .chat-control-btn:hover,
        .chat-toggle-btn:hover {
            transform: scale(1.1);
            filter: brightness(1.2);
        }

        /* Specific Button Colors */
        #voiceChatBtn {
            background: linear-gradient(135deg, #3b82f6, #6366f1); /* Blue/Indigo */
        }

        #chatMuteBtn {
            background: linear-gradient(135deg, #f97316, #ea580c); /* Orange/Red */
        }

        #toggleChat {
            background: linear-gradient(135deg, #6b7280, #4b5563); /* Cool Gray */
        }
        
        /* State-based colors */
        .chat-control-btn.muted {
            background: linear-gradient(135deg, #ef4444, #b91c1c); /* Vibrant Red for Mute */
            color: #fff; /* Ensure icon color is white */
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }

        .chat-message {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 12px 18px;
            border-radius: 18px;
            max-width: 85%;
            word-wrap: break-word;
        }

        .chat-message.own {
            align-self: flex-end;
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.8) 0%, rgba(52, 152, 219, 0.6) 100%);
            color: #fff;
        }

        .chat-message.other {
            align-self: flex-start;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.1) 100%);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .system-message {
            align-self: center;
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.3) 0%, rgba(255, 193, 7, 0.1) 100%);
            color: #fff;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            text-align: center;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }

        .message-sender {
            font-size: 0.85em;
            font-weight: bold;
            opacity: 0.8;
        }

        .message-text {
            font-size: 1em;
            line-height: 1.5;
        }

        .message-time {
            font-size: 0.75em;
            opacity: 0.6;
            align-self: flex-end;
        }

        .chat-input-container {
            display: flex;
            gap: 12px;
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0 0 18px 18px;
        }

        #chatInput {
            flex: 1;
            padding: 12px 18px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 1em;
            outline: none;
            transition: all 0.3s ease;
        }

        #chatInput::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        #chatInput:focus {
            border-color: rgba(52, 152, 219, 0.8);
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.3);
        }

        .chat-controls-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .emoji-btn,
        .sound-btn {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.1) 100%);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 35px;
            height: 35px;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 1.1em;
        }

        .emoji-btn:hover,
        .sound-btn:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.4) 0%, rgba(255, 255, 255, 0.2) 100%);
            transform: scale(1.1);
        }

        .emoji-picker {
            position: absolute;
            bottom: 100%;
            right: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
            backdrop-filter: blur(25px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 15px;
            display: none;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .emoji-picker.show {
            display: grid;
        }

        .emoji-item {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s ease;
            font-size: 1.2em;
        }

        .emoji-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.2);
        }

        .sound-keys {
            position: absolute;
            bottom: 100%;
            left: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
            backdrop-filter: blur(25px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 15px;
            display: none;
            flex-direction: column;
            gap: 8px;
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .sound-keys.show {
            display: flex;
        }

        .sound-key {
            padding: 8px 12px;
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.3) 0%, rgba(52, 152, 219, 0.1) 100%);
            border: 1px solid rgba(52, 152, 219, 0.3);
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9em;
            text-align: center;
        }

        .sound-key:hover {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.5) 0%, rgba(52, 152, 219, 0.3) 100%);
            transform: scale(1.05);
        }

        .send-btn {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 50%, #1f618d 100%);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 45px;
            height: 45px;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-size: 1.2em;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            box-shadow: 
                0 4px 15px rgba(52, 152, 219, 0.4),
                inset 0 1px 2px rgba(255, 255, 255, 0.2),
                0 2px 8px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
            animation: sendButtonGlow 3s ease-in-out infinite;
        }

        .send-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s ease;
        }

        .send-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.3s ease;
        }

        .send-btn:hover {
            transform: scale(1.15) rotate(5deg);
            box-shadow: 
                0 8px 25px rgba(52, 152, 219, 0.6),
                inset 0 1px 3px rgba(255, 255, 255, 0.3),
                0 4px 15px rgba(0, 0, 0, 0.3);
            background: linear-gradient(135deg, #5dade2 0%, #3498db 50%, #2980b9 100%);
            border-color: rgba(255, 255, 255, 0.5);
            animation: sendButtonPulse 0.8s ease-in-out infinite;
        }

        .send-btn:hover::before {
            left: 100%;
        }

        .send-btn:hover::after {
            width: 100%;
            height: 100%;
        }

        .send-btn:active {
            transform: scale(0.95) rotate(0deg);
            box-shadow: 
                0 2px 10px rgba(52, 152, 219, 0.4),
                inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            box-shadow: none;
            animation: none;
        }

        .send-btn:disabled::before,
        .send-btn:disabled::after {
            display: none;
        }

        @keyframes sendButtonGlow {
            0%, 100% { 
                box-shadow: 
                    0 4px 15px rgba(52, 152, 219, 0.4),
                    inset 0 1px 2px rgba(255, 255, 255, 0.2),
                    0 2px 8px rgba(0, 0, 0, 0.2);
            }
            50% { 
                box-shadow: 
                    0 6px 20px rgba(52, 152, 219, 0.6),
                    inset 0 1px 2px rgba(255, 255, 255, 0.2),
                    0 2px 8px rgba(0, 0, 0, 0.2);
            }
        }

        @keyframes sendButtonPulse {
            0%, 100% { 
                transform: scale(1.15) rotate(5deg);
            }
            50% { 
                transform: scale(1.2) rotate(5deg);
            }
        }

        /* Voice Chat Styles */
        .voice-chat-status {
            padding: 15px;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(16, 185, 129, 0.1) 100%);
            border-top: 1px solid rgba(16, 185, 129, 0.3);
            border-bottom: 1px solid rgba(16, 185, 129, 0.3);
        }

        .voice-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #10b981;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .voice-indicator i {
            animation: pulse 1.5s infinite;
        }

        .voice-indicator.recording {
            color: #ef4444;
        }

        .voice-indicator.recording i {
            animation: recordingPulse 0.8s infinite;
        }

        .connected-players {
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.8);
            text-align: center;
        }

        .chat-control-btn.voice-active {
            background: linear-gradient(135deg, #22c55e, #16a34a); /* Vibrant Green for Active */
            box-shadow: 0 0 12px rgba(34, 197, 94, 0.8);
            animation: pulse 1.5s infinite;
        }

        .chat-control-btn.voice-active i {
            animation: none; /* Removed from icon, now on the button */
        }

        @keyframes recordingPulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Voice Chat Modal */
        .voice-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .voice-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .voice-modal-content {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
            backdrop-filter: blur(25px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            color: #fff;
            max-width: 400px;
            width: 90%;
        }

        .voice-modal h3 {
            margin-bottom: 20px;
            color: #10b981;
        }

        .voice-permission-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: none;
            color: #fff;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
        }

        .voice-permission-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }

        .voice-permission-btn:disabled {
            background: #6b7280;
            cursor: not-allowed;
            transform: none;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header-container {
                padding: 10px 15px;
                margin-bottom: 15px;
            }
            
            .game-title {
                font-size: 2.2em;
            }
            
            .logo {
                width: 50px;
                height: 50px;
            }
            
            .player-info {
                position: relative;
                top: auto;
                right: auto;
                margin-bottom: 15px;
                width: 100%;
                justify-content: center;
                z-index: 100;
            }
            
            .game-container {
                padding: 20px;
                margin: 10px;
                min-height: 600px;
            }
            
            .boxes-grid {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
                gap: 15px;
                padding: 15px;
                margin: 20px 0;
            }
            
            .box {
                width: 100px;
                height: 100px;
            }
            
            .controls {
                gap: 15px;
                margin-bottom: 20px;
            }
            
            .bet-button {
                padding: 15px 25px;
                font-size: 1.1em;
                min-width: 180px;
            }
            
            .score-board-in-main {
                padding: 15px 20px;
                margin-bottom: 20px;
                font-size: 1em;
                gap: 10px;
            }
            
            .score-board-in-main .score-item {
                padding: 6px 10px;
                font-size: 0.9em;
            }
            
            /* Chat responsive */
            .chat-container {
                width: 300px;
                height: 400px;
                right: 0px;
                top: 100px;
                bottom: auto;
                border-radius: 20px 0 0 20px;
            }
            
            .chat-container.collapsed {
                width: 60px;
            }
            
            .chat-controls {
                gap: 6px;
            }
            
            .chat-control-btn,
            .chat-toggle-btn {
                width: 28px;
                height: 28px;
                font-size: 0.9em;
            }
            
            .voice-chat-status {
                padding: 12px;
            }
            
            .voice-indicator {
                font-size: 0.9em;
            }
        }

        @media (max-width: 480px) {
            .header-container {
                padding: 8px 12px;
            }
            
            .game-title {
                font-size: 1.8em;
            }
            
            .logo {
                width: 40px;
                height: 40px;
            }
            
            .boxes-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
                padding: 10px;
            }
            
            .box {
                width: 80px;
                height: 80px;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
                gap: 10px;
                margin-bottom: 15px;
            }
            
            .bet-button {
                width: 100%;
                max-width: 250px;
                min-width: auto;
            }
            
            .score-board-in-main {
                flex-direction: column;
                align-items: center;
                gap: 8px;
                margin-bottom: 15px;
            }
            
            .score-board-in-main .score-item {
                width: 100%;
                text-align: center;
            }
            
            .player-info {
                flex-direction: column;
                gap: 10px;
                padding: 12px 15px;
            }
            
            .player-actions {
                justify-content: center;
            }
            
            /* Chat responsive for mobile */
            .chat-container {
                width: 280px;
                height: 380px;
                right: 0px;
                top: 100px;
                bottom: auto;
                border-radius: 20px 0 0 20px;
            }
            
            .chat-container.collapsed {
                width: 55px;
            }
            
            .chat-header {
                padding: 10px 15px;
            }
            
            .chat-header h3 {
                font-size: 1em;
            }
            
            .chat-controls {
                gap: 5px;
            }
            
            .chat-control-btn,
            .chat-toggle-btn {
                width: 25px;
                height: 25px;
                font-size: 0.8em;
            }
            
            .voice-chat-status {
                padding: 10px;
            }
            
            .voice-indicator {
                font-size: 0.8em;
                gap: 8px;
            }
            
            .connected-players {
                font-size: 0.8em;
            }
            
            .chat-messages {
                padding: 10px;
            }
            
            .chat-input-container {
                padding: 10px;
            }
            
            #chatInput {
                padding: 8px 12px;
                font-size: 0.85em;
            }
            
            .send-btn {
                width: 40px;
                height: 40px;
                font-size: 1.1em;
            }
            
            /* Voice modal responsive */
            .voice-modal-content {
                padding: 20px;
                margin: 20px;
            }
            
            .voice-modal h3 {
                font-size: 1.2em;
            }
            
            .voice-permission-btn {
                padding: 12px 25px;
                font-size: 1em;
                margin: 8px;
            }
        }

        @media (max-width: 1200px) {
            .main-content {
                flex-direction: column;
                align-items: center;
                padding-right: 0;
            }

            .right-panel {
                position: static;
                width: 100%;
                max-width: 900px;
                margin: 20px auto 0;
                padding: 0;
            }

            .chat-container {
                position: relative;
                top: auto;
                width: 100%;
                max-width: 900px;
                height: 500px;
                border-radius: 20px;
            }
        }

        /* Header Styles from game1.html */
        .header-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            margin-bottom: 20px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            padding: 10px 15px;
            border-radius: 20px;
            position: relative;
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }

        .centered-header-content {
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1;
        }

        .logo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid #3498db;
            object-fit: cover;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
            transition: all 0.3s ease;
        }

        .logo:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.6);
        }

        .game-title {
            font-family: 'Amiri', serif;
            font-size: 2.2em;
            color: #3498db;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.7);
            margin: 0;
            animation: pulse 2s infinite ease-in-out;
        }
        
        @keyframes pulse {
            from { transform: scale(1); opacity: 1; }
            to { transform: scale(1.05); opacity: 0.8; }
        }

        /* Score Board Styles from game1.html */
        .score-board-in-main {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.8) 0%, rgba(52, 152, 219, 0.6) 100%);
            padding: 20px 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            font-size: 1.2em;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .score-board-in-main:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.4);
        }

        .score-board-in-main .score-item {
            font-weight: bold;
            color: #ECF0F1;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
            padding: 8px 12px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .score-board-in-main .score-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        .score-board-in-main .score-item span {
            color: #FFD700;
            font-size: 1.1em;
            font-weight: 900;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
        }

        #win-gif-container {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 300px;
            height: 200px;
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.95) 0%, rgba(255, 193, 7, 0.9) 100%);
            border-radius: 20px;
            z-index: 9999; /* Very high z-index to ensure visibility */
            backdrop-filter: blur(10px);
            border: 3px solid rgba(255, 255, 255, 0.5);
            box-shadow: 
                0 0 30px rgba(255, 215, 0, 0.8),
                0 0 60px rgba(255, 193, 7, 0.6),
                0 0 100px rgba(255, 215, 0, 0.4);
            animation: winContainerSlide 0.5s ease-out, winContainerGlow 2s infinite alternate ease-in-out;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            opacity: 1;
            visibility: visible;
        }

        #win-gif-container.show {
            display: flex !important;
            opacity: 1 !important;
            visibility: visible !important;
        }

        #win-gif-container .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        #win-gif-container .close-btn:hover {
            background: rgba(0, 0, 0, 0.9);
            transform: scale(1.1);
        }

        @keyframes winContainerSlide {
            0% {
                transform: translateX(100%);
                opacity: 0;
            }
            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes winContainerGlow {
            0% {
                box-shadow: 
                    0 0 30px rgba(255, 215, 0, 0.8),
                    0 0 60px rgba(255, 193, 7, 0.6),
                    0 0 100px rgba(255, 215, 0, 0.4);
            }
            100% {
                box-shadow: 
                    0 0 50px rgba(255, 215, 0, 1),
                    0 0 100px rgba(255, 193, 7, 0.8),
                    0 0 150px rgba(255, 215, 0, 0.6);
            }
        }

        #win-gif-container img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 15px;
            filter: brightness(1.2) contrast(1.1) saturate(1.3);
            transition: all 0.3s ease;
            display: block;
        }

        #win-gif-container img:hover {
            transform: scale(1.05);
            filter: brightness(1.4) contrast(1.2) saturate(1.5);
        }

        /* Win Amount Display */
        #win-amount-display {
            position: absolute;
            top: -50px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.98) 0%, rgba(255, 193, 7, 0.95) 100%);
            color: #000;
            padding: 12px 24px;
            border-radius: 30px;
            font-size: 1.8em;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            box-shadow: 
                0 0 20px rgba(255, 215, 0, 0.8),
                0 0 40px rgba(255, 193, 7, 0.6),
                0 0 60px rgba(255, 215, 0, 0.4);
            animation: winAmountGlow 2s infinite alternate ease-in-out;
            z-index: 10001;
            border: 3px solid rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            white-space: nowrap;
            display: none;
        }

        #win-amount-display.show {
            display: block !important;
        }

        @keyframes winAmountGlow {
            0% {
                box-shadow: 
                    0 0 20px rgba(255, 215, 0, 0.8),
                    0 0 40px rgba(255, 193, 7, 0.6),
                    0 0 60px rgba(255, 215, 0, 0.4);
                transform: translateX(-50%) scale(1);
            }
            100% {
                box-shadow: 
                    0 0 30px rgba(255, 215, 0, 1),
                    0 0 60px rgba(255, 193, 7, 0.8),
                    0 0 90px rgba(255, 215, 0, 0.6);
                transform: translateX(-50%) scale(1.05);
            }
        }

        /* Sad Cat GIF Container */
        #sadcat-gif-container {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 300px;
            height: 200px;
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.95) 0%, rgba(75, 0, 130, 0.9) 100%);
            border-radius: 20px;
            z-index: 9999; /* Very high z-index to ensure visibility */
            backdrop-filter: blur(10px);
            border: 3px solid rgba(255, 255, 255, 0.3);
            box-shadow: 
                0 0 30px rgba(139, 0, 0, 0.6),
                0 0 60px rgba(75, 0, 130, 0.4),
                0 0 100px rgba(139, 0, 0, 0.3);
            animation: sadcatContainerSlide 0.5s ease-out, sadcatContainerGlow 3s infinite alternate ease-in-out;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            opacity: 1;
            visibility: visible;
        }

        #sadcat-gif-container.show {
            display: flex !important;
            opacity: 1 !important;
            visibility: visible !important;
        }

        #sadcat-gif-container .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        #sadcat-gif-container .close-btn:hover {
            background: rgba(0, 0, 0, 0.9);
            transform: scale(1.1);
        }

        @keyframes sadcatContainerSlide {
            0% {
                transform: translateX(-100%);
                opacity: 0;
            }
            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes sadcatContainerGlow {
            0% {
                box-shadow: 
                    0 0 30px rgba(139, 0, 0, 0.6),
                    0 0 60px rgba(75, 0, 130, 0.4),
                    0 0 100px rgba(139, 0, 0, 0.3);
            }
            50% {
                box-shadow: 
                    0 0 40px rgba(75, 0, 130, 0.7),
                    0 0 80px rgba(47, 79, 79, 0.5),
                    0 0 120px rgba(139, 0, 0, 0.6);
            }
            100% {
                box-shadow: 
                    0 0 50px rgba(47, 79, 79, 0.8),
                    0 0 100px rgba(139, 0, 0, 0.6),
                    0 0 150px rgba(75, 0, 130, 0.4);
            }
        }

        #sadcat-gif-container img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 15px;
            filter: brightness(0.9) contrast(1.1) saturate(1.2);
            transition: all 0.3s ease;
            display: block;
        }

        #sadcat-gif-container img:hover {
            transform: scale(1.05);
            filter: brightness(1.1) contrast(1.2) saturate(1.3);
        }

        /* Lose Amount Display */
        #lose-amount-display {
            position: absolute;
            top: -50px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.98) 0%, rgba(75, 0, 130, 0.95) 100%);
            color: #fff;
            padding: 12px 24px;
            border-radius: 30px;
            font-size: 1.8em;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
            box-shadow: 
                0 0 20px rgba(139, 0, 0, 0.6),
                0 0 40px rgba(75, 0, 130, 0.4),
                0 0 60px rgba(139, 0, 0, 0.3);
            animation: loseAmountGlow 3s infinite alternate ease-in-out;
            z-index: 10001;
            border: 3px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            white-space: nowrap;
            display: none;
        }

        #lose-amount-display.show {
            display: block !important;
        }

        @keyframes loseAmountGlow {
            0% {
                box-shadow: 
                    0 0 20px rgba(139, 0, 0, 0.6),
                    0 0 40px rgba(75, 0, 130, 0.4),
                    0 0 60px rgba(139, 0, 0, 0.3);
                transform: translateX(-50%) scale(1);
            }
            100% {
                box-shadow: 
                    0 0 50px rgba(255, 0, 0, 1),
                    0 0 100px rgba(220, 53, 69, 0.8);
                transform: translateX(-50%) scale(1.05);
            }
        }

        @keyframes winGifGlow {
            0% {
                box-shadow: 
                    0 0 50px rgba(255, 215, 0, 0.7),
                    0 0 100px rgba(255, 0, 255, 0.5),
                    0 0 150px rgba(0, 255, 255, 0.3),
                    0 0 200px rgba(255, 255, 0, 0.2);
                filter: 
                    brightness(1.2) 
                    contrast(1.1) 
                    saturate(1.3) 
                    hue-rotate(0deg);
            }
            25% {
                box-shadow: 
                    0 0 60px rgba(255, 0, 255, 0.8),
                    0 0 120px rgba(0, 255, 255, 0.6),
                    0 0 180px rgba(255, 255, 0, 0.4),
                    0 0 240px rgba(255, 215, 0, 0.3);
                filter: 
                    brightness(1.3) 
                    contrast(1.15) 
                    saturate(1.4) 
                    hue-rotate(90deg);
            }
            50% {
                box-shadow: 
                    0 0 70px rgba(0, 255, 255, 0.9),
                    0 0 140px rgba(255, 255, 0, 0.7),
                    0 0 210px rgba(255, 215, 0, 0.5),
                    0 0 280px rgba(255, 0, 255, 0.4);
                filter: 
                    brightness(1.4) 
                    contrast(1.2) 
                    saturate(1.5) 
                    hue-rotate(180deg);
            }
            75% {
                box-shadow: 
                    0 0 80px rgba(255, 255, 0, 1),
                    0 0 160px rgba(255, 215, 0, 0.8),
                    0 0 240px rgba(255, 0, 255, 0.6),
                    0 0 320px rgba(0, 255, 255, 0.5);
                filter: 
                    brightness(1.5) 
                    contrast(1.25) 
                    saturate(1.6) 
                    hue-rotate(270deg);
            }
            100% {
                box-shadow: 
                    0 0 90px rgba(255, 215, 0, 1),
                    0 0 180px rgba(255, 0, 255, 0.9),
                    0 0 270px rgba(0, 255, 255, 0.7),
                    0 0 360px rgba(255, 255, 0, 0.6);
                filter: 
                    brightness(1.6) 
                    contrast(1.3) 
                    saturate(1.7) 
                    hue-rotate(360deg);
            }
        }

        /* Add rainbow border effect */
        #win-gif-container::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: calc(90% + 20px);
            height: calc(90% + 20px);
            background: linear-gradient(
                45deg,
                #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3,
                #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3
            );
            background-size: 400% 400%;
            border-radius: 25px;
            z-index: -1;
            animation: rainbowBorder 3s ease-in-out infinite;
            filter: blur(2px);
        }

        @keyframes rainbowBorder {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        /* Add sparkle effects around the GIF */
        #win-gif-container::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.8) 2px, transparent 2px),
                radial-gradient(circle at 80% 30%, rgba(255, 215, 0, 0.8) 3px, transparent 3px),
                radial-gradient(circle at 40% 70%, rgba(255, 0, 255, 0.8) 2px, transparent 2px),
                radial-gradient(circle at 90% 80%, rgba(0, 255, 255, 0.8) 3px, transparent 3px),
                radial-gradient(circle at 10% 90%, rgba(255, 255, 0, 0.8) 2px, transparent 2px),
                radial-gradient(circle at 70% 10%, rgba(255, 215, 0, 0.8) 3px, transparent 3px);
            background-size: 200px 200px, 150px 150px, 180px 180px, 120px 120px, 160px 160px, 140px 140px;
            animation: sparkle 4s linear infinite;
            pointer-events: none;
        }

        @keyframes sparkle {
            0% {
                background-position: 0px 0px, 0px 0px, 0px 0px, 0px 0px, 0px 0px, 0px 0px;
            }
            100% {
                background-position: 200px 200px, 150px 150px, 180px 180px, 120px 120px, 160px 160px, 140px 140px;
            }
        }

        /* Item Collection Display */
        .item-collection-display {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
            backdrop-filter: blur(25px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 15px;
            margin: 15px 0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .item-collection-title {
            color: #fff;
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
            margin-bottom: 10px;
        }

        .item-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .item-display.negative {
            border-color: rgba(239, 68, 68, 0.6);
            background: rgba(239, 68, 68, 0.1);
            animation: negativeItemPulse 2s infinite;
        }

        @keyframes negativeItemPulse {
            0%, 100% { 
                border-color: rgba(239, 68, 68, 0.6);
                box-shadow: 0 0 5px rgba(239, 68, 68, 0.3);
            }
            50% { 
                border-color: rgba(239, 68, 68, 0.9);
                box-shadow: 0 0 15px rgba(239, 68, 68, 0.6);
            }
        }

        @keyframes negativeItemShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-3px); }
            75% { transform: translateX(3px); }
        }

        .item-display:hover {
            transform: scale(1.05);
            background: rgba(255, 255, 255, 0.2);
        }

        .item-display.negative:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        .item-emoji {
            font-size: 1.5em;
            margin-bottom: 5px;
        }

        .item-count {
            color: #fff;
            font-size: 0.9em;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .item-progress {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            margin-top: 5px;
            overflow: hidden;
        }

        .item-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #ffd700, #ffed4e);
            border-radius: 2px;
            transition: width 0.5s ease;
        }

        .collection-reward {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #000;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: bold;
            text-align: center;
            margin-top: 10px;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
            animation: collectionRewardGlow 2s infinite alternate;
        }

        @keyframes collectionRewardGlow {
            0% { box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4); }
            100% { box-shadow: 0 6px 20px rgba(255, 215, 0, 0.6); }
        }

        /* Item Found Animation */
        .item-found {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.9) 100%);
            backdrop-filter: blur(20px);
            border: 3px solid;
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            z-index: 1000;
            animation: itemFoundPop 0.6s ease-out;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .item-found.positive {
            border-color: #10b981;
            color: #10b981;
        }

        .item-found.negative {
            border-color: #ef4444;
            color: #ef4444;
        }

        .item-found-emoji {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .item-found-text {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .item-found-points {
            font-size: 1.1em;
            opacity: 0.8;
        }

        @keyframes itemFoundPop {
            0% { 
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 0;
            }
            50% { 
                transform: translate(-50%, -50%) scale(1.1);
                opacity: 1;
            }
            100% { 
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        /* Item Info Modal */
        .item-info-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .item-info-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .item-info-content {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
            backdrop-filter: blur(25px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            color: #fff;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .item-info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        .item-info-title {
            font-size: 1.8em;
            font-weight: bold;
            color: #3498db;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .item-info-close {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            border: none;
            color: #fff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
        }

        .item-info-close:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.6);
        }

        .item-info-grid {
            display: grid;
            gap: 20px;
            margin-bottom: 25px;
        }

        .item-info-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
        }

        .item-info-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .item-info-emoji {
            font-size: 2.5em;
            min-width: 60px;
            text-align: center;
        }

        .item-info-details {
            flex: 1;
        }

        .item-info-name {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 8px;
            color: #fff;
        }

        .item-info-description {
            font-size: 1em;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .item-info-points {
            font-size: 1.1em;
            font-weight: bold;
            padding: 5px 12px;
            border-radius: 20px;
            display: inline-block;
        }

        .item-info-points.positive {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: #fff;
        }

        .item-info-points.negative {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: #fff;
        }

        .collection-goals-section {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2) 0%, rgba(255, 215, 0, 0.1) 100%);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        .collection-goals-title {
            font-size: 1.4em;
            font-weight: bold;
            color: #ffd700;
            text-align: center;
            margin-bottom: 15px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .collection-goals-list {
            display: grid;
            gap: 10px;
        }

        .collection-goal-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .collection-goal-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .collection-goal-emoji {
            font-size: 1.5em;
        }

        .collection-goal-text {
            font-size: 1em;
            color: #fff;
        }

        .collection-goal-reward {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #000;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 0.9em;
        }

        /* Info Button */
        .item-info-btn {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 45px;
            height: 45px;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 1.2em;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
            position: relative;
            overflow: hidden;
        }

        .item-info-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s ease;
        }

        .item-info-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.6);
        }

        .item-info-btn:hover::before {
            left: 100%;
        }

        /* Voice Chat Controls */
        .voice-chat-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .voice-chat-controls .voice-btn {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(34, 197, 94, 0.4);
        }

        .voice-chat-controls .voice-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 15px rgba(34, 197, 94, 0.6);
        }

        .voice-chat-controls .voice-btn.muted {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.4);
        }

        .voice-chat-controls .voice-btn.muted:hover {
            box-shadow: 0 6px 15px rgba(239, 68, 68, 0.6);
        }

        .voice-status {
            color: #fff;
            font-size: 1em;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="main-content">
        <div class="game-container">
            <div class="header-container">
                <div class="centered-header-content">
                    <img src="logo.png" alt=" " class="logo">
                    <h1 class="game-title">Voice Boom</h1>
                </div>
            </div>
            <div class="message-area" id="message-area"></div>
            
            <div class="controls">
                <button id="single-shot-button" class="bet-button">
                    <i class="fas fa-crosshairs"></i>
                      (100)
                </button>
                <button id="triple-shot-button" class="bet-button">
                    <i class="fas fa-bullseye"></i>
                      (300)
                </button>
                <button id="hammer-shot-button" class="bet-button">
                    <i class="fas fa-hammer"></i>
                      (500)
                </button>
            </div>
            
            <!-- Item Collection Display -->
            <div class="item-collection-display" id="itemCollectionDisplay">
                <div class="item-collection-title">
                      
                    <button id="itemInfoBtn" class="item-info-btn" title=" ">
                        <i class="fas fa-info-circle"></i>
                    </button>
                </div>
                <div class="items-grid" id="itemsGrid">
                    <!-- Items will be generated by JavaScript -->
                </div>
                <div class="collection-reward" id="collectionReward" style="display: none;">
                      !
                </div>
            </div>
            
            <div class="boxes-grid" id="boxes-container">
                <!-- Boxes will be generated by JavaScript -->
            </div>
            <div id="seeker-hero"></div>
        </div>
    </div>
    
    <div class="right-panel">
    <div class="player-info">
        <div class="player-details">
            <p><span id="username-display"></span></p>
            <p><span id="balance-display"></span></p>
        </div>
        <div class="player-actions">
            <button id="recharge-button" title=" "></button>
            <button id="logout-button" title=" "></button>
            <button id="mute-button" title="/  "></button>
        </div>
    </div>
        <!-- Chat Window -->
        <div class="chat-container" id="chatContainer">
            <div class="chat-header">
                <h3><i class="fas fa-comments"></i> </h3>
                <div class="chat-controls">
                    <button id="reconnectBtn" class="chat-control-btn" title=" " style="background: linear-gradient(135deg, #10b981, #059669);">
                        <i class="fas fa-wifi"></i>
                    </button>
                    <button id="voiceChatBtn" class="chat-control-btn" title="  ">
                        <i class="fas fa-microphone-slash"></i>
                    </button>
                    <button id="chatMuteBtn" class="chat-control-btn" title="  ">
                        <i class="fas fa-volume-up"></i>
                    </button>
                    <button id="toggleChat" class="chat-toggle-btn">
                        <i class="fas fa-chevron-right"></i>
                    </button>
            </div>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="system-message">
                    <span class="message-time"></span>
                    <span class="message-text">!      </span>
                </div>
            </div>
            <div class="voice-chat-status" id="voiceChatStatus" style="display: none;">
                <div class="voice-indicator">
                    <i class="fas fa-microphone"></i>
                    <span>  </span>
                </div>
                <div class="connected-players" id="connectedPlayers">
                    <span> : 0</span>
                </div>
            </div>
            <div class="chat-input-container">
                <div class="chat-controls-row" style="position: relative;">
                    <button id="emojiBtn" class="emoji-btn" title="  ">
                        
                    </button>
                    <div id="emojiPicker" class="emoji-picker">
                        <div class="emoji-item"></div>
                        <div class="emoji-item"></div>
                        <div class="emoji-item"></div>
                        <div class="emoji-item"></div>
                        <div class="emoji-item"></div>
                        <div class="emoji-item"></div>
                        <div class="emoji-item"></div>
                        <div class="emoji-item"></div>
                        <div class="emoji-item"></div>
                        <div class="emoji-item"></div>
                        <div class="emoji-item"></div>
                        <div class="emoji-item"></div>
                        <div class="emoji-item"></div>
                        <div class="emoji-item"></div>
                        <div class="emoji-item"></div>
                        <div class="emoji-item"></div>
                        <div class="emoji-item"></div>
                        <div class="emoji-item"></div>
                        <div class="emoji-item"></div>
                        <div class="emoji-item"></div>
                        <div class="emoji-item"></div>
                        <div class="emoji-item"></div>
                        <div class="emoji-item"></div>
        </div>
    </div>

                <div class="chat-controls-row" style="position: relative;">
                    <button id="soundBtn" class="sound-btn" title=" ">
                        
                    </button>
                    <div id="soundKeys" class="sound-keys">
                        <div class="sound-key" data-sound="win"> </div>
                        <div class="sound-key" data-sound="lose"> </div>
                        <div class="sound-key" data-sound="click"> </div>
                        <div class="sound-key" data-sound="single">  </div>
                        <div class="sound-key" data-sound="triple">  </div>
                        <div class="sound-key" data-sound="hammer">  </div>
            </div>
            </div>
                
                <input type="text" id="chatInput" placeholder="  ..." maxlength="100">
                <button id="sendMessage" class="send-btn">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="loading-indicator">  ...</div>

    <!-- Voice Chat Modal -->
    <div class="voice-modal" id="voiceModal">
        <div class="voice-modal-content">
            <h3><i class="fas fa-microphone"></i>  </h3>
            <p>       </p>
            <button id="enableVoiceBtn" class="voice-permission-btn">
                <i class="fas fa-microphone"></i>  
            </button>
            <button id="cancelVoiceBtn" class="voice-permission-btn" style="background: #6b7280;">
                
            </button>
        </div>
    </div>

    <div id="win-gif-container">
        <button class="close-btn" id="closeWinGif"></button>
        <img src="WIN.GIF" alt="Win GIF">
        <div id="win-amount-display" style="display: none;">
            <span id="win-amount-text"></span>
        </div>
    </div>

    <div id="sadcat-gif-container">
        <button class="close-btn" id="closeSadcatGif"></button>
        <img src="sadcat.gif" alt="Sadcat GIF">
        <div id="lose-amount-display" style="display: none;">
            <span id="lose-amount-text"></span>
        </div>
    </div>

    <audio id="winSound" src="win.mp3"></audio>
    <audio id="loseSound" src="lose.mp3"></audio>
    <audio id="buttonClick" src="click.mp3"></audio>
    <audio id="winGifSound" src="WIN1.MP3"></audio>
    <audio id="loseGifSound" src="LOOS.mp3"></audio>
    
    <!-- Chat Audio -->
    <audio id="chatNotification" src="sounds/click.mp3"></audio>
    <audio id="messageSent" src="click.mp3"></audio>

    <!-- Item Info Modal -->
    <div class="item-info-modal" id="itemInfoModal">
        <div class="item-info-content">
            <div class="item-info-header">
                <h2 class="item-info-title">  </h2>
                <button class="item-info-close" id="itemInfoClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="item-info-grid" id="itemInfoGrid">
                <!-- Items will be generated by JavaScript -->
            </div>
            
            <div class="collection-goals-section">
                <h3 class="collection-goals-title">  </h3>
                <div class="collection-goals-list" id="collectionGoalsList">
                    <!-- Goals will be generated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Voice Chat Controls -->
    <div class="voice-chat-controls">
        <button id="voice-mic-btn" class="voice-btn" title="/ ">
            <i class="fas fa-microphone"></i>
        </button>
        <div id="voice-status" class="voice-status">    </div>
    </div>

    <script>
        const BACKEND_URL = 'https://mygame25bita.onrender.com';

        // Game State
        let score = 0;
        let highScore = 0;
        let roundNumber = 1;
        let username = '';
        let isProcessingShot = false;
        
        // Item Collection System
        let collectedGems = 0;
        let totalGemsCollected = 0;
        let batsHit = 0;
        let itemsCollected = {
            gem: 0,
            key: 0,
            coin: 0,
            bomb: 0,
            star: 0,
            bat: 0
        };
        
        // Item Rewards Configuration
        const ITEM_REWARDS = {
            gem: { points: 75, name: '', emoji: '', color: '#ff69b4' },      // Increased from 50
            key: { points: 150, name: '', emoji: '', color: '#ffd700' },     // Increased from 100
            coin: { points: 40, name: '', emoji: '', color: '#ffd700' },      // Increased from 25
            bomb: { points: -50, name: '', emoji: '', color: '#ff4500' },    // Reduced from -100
            star: { points: 300, name: '', emoji: '', color: '#ffd700' },     // Increased from 200
            bat: { points: -75, name: '', emoji: '', color: '#8b4513' }      // Reduced from -250
        };
        
        // Collection Goals
        const COLLECTION_GOALS = {
            gem: { target: 5, reward: 1500, name: '' },    // Increased from 1000
            key: { target: 3, reward: 800, name: '' },    // Increased from 500
            star: { target: 2, reward: 1200, name: '' }     // Increased from 800
        };

        // DOM Elements
        const usernameDisplay = document.getElementById('username-display');
        const balanceDisplay = document.getElementById('balance-display');
        const boxesContainer = document.getElementById('boxes-container');
        const messageArea = document.getElementById('message-area');
        const singleShotButton = document.getElementById('single-shot-button');
        const tripleShotButton = document.getElementById('triple-shot-button');
        const hammerShotButton = document.getElementById('hammer-shot-button');
        const logoutButton = document.getElementById('logout-button');
        const seekerImage = document.getElementById('seeker-hero');
        const loadingIndicator = document.getElementById('loading-indicator');
        const rechargeButton = document.getElementById('recharge-button');
        const muteButton = document.getElementById('mute-button');

        // Sound Effects
        const sounds = {
            win: new Audio('win.mp3'),
            lose: new Audio('lose.mp3'),
            buttonClick: new Audio('click.mp3'),
            singleShot: new Audio(' .mp3'),
            tripleShot: new Audio('  .mp3'), // Corrected filename with space
            hammerShot: new Audio('hammerShot.mp3'),
            winGif: new Audio('WIN1.MP3'),
            loseGif: new Audio('LOOS.mp3')
        };

        // Check if audio files exist
        function checkAudioFiles() {
            Object.entries(sounds).forEach(([name, audio]) => {
                audio.addEventListener('error', (e) => {
                    console.error(`Audio file error for ${name}:`, e);
                });
                audio.addEventListener('loadstart', () => {
                    console.log(`Audio file ${name} loading started`);
                });
                audio.addEventListener('canplay', () => {
                    console.log(`Audio file ${name} ready to play`);
                });
            });
        }

        let isMuted = false;
        let isChatMuted = false; // New variable for chat sounds
        let chatVolume = 0.5; // Chat volume level

        const BETS = {
            single: { cost: 100, multiplier: 2.5 },   // Increased from 2.0
            triple: { cost: 300, multiplier: 3.0 },   // Increased from 2.5
            hammer: { cost: 500, multiplier: 4.0 }    // Increased from 3.0
        };

        // Utility Functions
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function showMessage(message, type = 'info') {
            messageArea.textContent = message;
            messageArea.className = 'message-area ' + type;
        }

        // Item Management Functions
        function initializeItemDisplay() {
            const itemsGrid = document.getElementById('itemsGrid');
            itemsGrid.innerHTML = '';
            
            // Create display for each item type
            const itemTypes = ['gem', 'key', 'coin', 'bomb', 'star', 'bat'];
            
            itemTypes.forEach(itemType => {
                const itemData = ITEM_REWARDS[itemType];
                const itemDisplay = document.createElement('div');
                itemDisplay.className = 'item-display';
                
                // Add negative class for items with negative points
                if (itemData.points < 0) {
                    itemDisplay.classList.add('negative');
                }
                
                itemDisplay.dataset.itemType = itemType;
                
                // Get current count
                const currentCount = itemsCollected[itemType] || 0;
                
                // Calculate progress for collection goals
                let progress = 0;
                let targetText = '';
                if (COLLECTION_GOALS[itemType]) {
                    const goal = COLLECTION_GOALS[itemType];
                    progress = Math.min((currentCount / goal.target) * 100, 100);
                    targetText = `${currentCount}/${goal.target}`;
                } else {
                    targetText = currentCount.toString();
                }
                
                itemDisplay.innerHTML = `
                    <div class="item-emoji">${itemData.emoji}</div>
                    <div class="item-count">${targetText}</div>
                    <div class="item-progress">
                        <div class="item-progress-bar" style="width: ${progress}%"></div>
                    </div>
                `;
                
                itemsGrid.appendChild(itemDisplay);
            });
        }

        function updateItemDisplay() {
            Object.entries(itemsCollected).forEach(([itemType, count]) => {
                const itemDisplay = document.querySelector(`[data-item-type="${itemType}"]`);
                if (itemDisplay) {
                    const countElement = itemDisplay.querySelector('.item-count');
                    const progressBar = itemDisplay.querySelector('.item-progress-bar');
                    
                    // Update count text
                    if (COLLECTION_GOALS[itemType]) {
                        const goal = COLLECTION_GOALS[itemType];
                        countElement.textContent = `${count}/${goal.target}`;
                    } else {
                        countElement.textContent = count.toString();
                    }
                    
                    // Update progress bar for collection goals
                    if (COLLECTION_GOALS[itemType]) {
                        const goal = COLLECTION_GOALS[itemType];
                        const progress = Math.min((count / goal.target) * 100, 100);
                        progressBar.style.width = `${progress}%`;
                    }
                }
            });
        }

        function addItem(itemType) {
            if (itemsCollected[itemType] !== undefined) {
                itemsCollected[itemType]++;
                updateItemDisplay();
                
                // Check for collection rewards
                checkCollectionRewards(itemType);
                
                // Show item found animation
                showItemFound(itemType);
                
                // Update score
                const itemData = ITEM_REWARDS[itemType];
                if (itemData) {
                    score += itemData.points;
                    updateDisplay();
                    
                    // Play sound for negative items
                    if (itemData.points < 0) {
                        sounds.lose.play().catch(e => console.log('Negative item sound error:', e));
                    }
                    
                    // Show in chat area
                    const pointsText = itemData.points > 0 ? `+${itemData.points}` : `${itemData.points}`;
                    addMessageToChat('', `${itemData.emoji}    <b>${itemData.name}</b> (${pointsText} )`, itemData.points > 0 ? 'system-message' : 'system-message error');
                }
                
                // Save data to server
                saveUserData();
            }
        }

        function showItemFound(itemType) {
            const itemData = ITEM_REWARDS[itemType];
            if (!itemData) return;
            
            const itemFound = document.createElement('div');
            itemFound.className = `item-found ${itemData.points >= 0 ? 'positive' : 'negative'}`;
            
            itemFound.innerHTML = `
                <div class="item-found-emoji">${itemData.emoji}</div>
                <div class="item-found-text">${itemData.name}</div>
                <div class="item-found-points">${itemData.points >= 0 ? '+' : ''}${itemData.points} </div>
            `;
            
            document.body.appendChild(itemFound);
            
            // Remove after animation
            setTimeout(() => {
                itemFound.remove();
            }, 2000);
        }

        function checkCollectionRewards(itemType) {
            const goal = COLLECTION_GOALS[itemType];
            if (!goal) return;
            
            if (itemsCollected[itemType] >= goal.target) {
                // Award collection bonus
                score += goal.reward;
                updateDisplay();
                
                // Show collection reward
                const rewardElement = document.getElementById('collectionReward');
                rewardElement.textContent = `  ${goal.name}: +${goal.reward} !`;
                rewardElement.style.display = 'block';
                
                // Hide after 3 seconds
                setTimeout(() => {
                    rewardElement.style.display = 'none';
                }, 3000);
                
                // Reset collection count
                itemsCollected[itemType] = 0;
                updateItemDisplay();
                
                // Save data
                saveUserData();
            }
        }

        function generateRandomItem() {
            const itemTypes = Object.keys(ITEM_REWARDS);
            const weights = {
                gem: 20,      // 20% chance (increased from 15%)
                key: 15,      // 15% chance (increased from 10%)
                coin: 30,     // 30% chance (increased from 25%)
                bomb: 12,     // 12% chance (reduced from 20%)
                star: 12,     // 12% chance (increased from 8%)
                bat: 11       // 11% chance (reduced from 22%)
            };
            
            const totalWeight = Object.values(weights).reduce((sum, weight) => sum + weight, 0);
            let random = Math.random() * totalWeight;
            
            for (const [itemType, weight] of Object.entries(weights)) {
                random -= weight;
                if (random <= 0) {
                    return itemType;
                }
            }
            
            return 'coin'; // Default fallback
        }

        function updateDisplay() {
            balanceDisplay.textContent = Math.round(score);
            usernameDisplay.textContent = username;

            // Disable buttons only if a shot is currently being processed
            const buttonsDisabled = isProcessingShot;
            singleShotButton.disabled = buttonsDisabled;
            tripleShotButton.disabled = buttonsDisabled;
            hammerShotButton.disabled = buttonsDisabled;
        }

        function createHero() {
            const hero = document.createElement('div');
            hero.id = 'hero';
            hero.textContent = 'C'; // Use text content 'C'
            hero.style.fontSize = '24px'; // Adjust size as needed
            hero.style.color = 'white'; // Set color
            hero.style.display = 'flex';
            hero.style.alignItems = 'center';
            hero.style.justifyContent = 'center';
            hero.style.fontWeight = 'bold';
            return hero;
        }

        function createBoxes(count = 10) {
            boxesContainer.innerHTML = '';
            for (let i = 0; i < count; i++) {
                const box = document.createElement('div');
                box.classList.add('box');
                box.dataset.id = i;

                const boxContent = document.createElement('div');
                boxContent.classList.add('box-content');

                const boxText = document.createElement('div');
                boxText.classList.add('box-text');

                const itemIcon = document.createElement('div');
                itemIcon.classList.add('item-icon');
                itemIcon.style.display = 'none'; // Hidden by default

                const coinIcon = document.createElement('div');
                coinIcon.classList.add('coin-icon');

                boxContent.appendChild(boxText);
                boxContent.appendChild(itemIcon);
                boxContent.appendChild(coinIcon);
                box.appendChild(boxContent);
                boxesContainer.appendChild(box);
            }
        }

        async function loadGameData() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/users/me`, { // <--    
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        // Token is invalid or expired, redirect to login
                        localStorage.removeItem('token');
                        localStorage.removeItem('username');
                        window.location.href = 'index.html';
                    }
                    throw new Error('Failed to load game data');
                }
                const data = await response.json();
                score = data.score || 1000; // Use data.score instead of personalScore
                highScore = data.highScore || score;
                roundNumber = data.roundNumber || 1;
                
                // Load collected items data
                if (data.itemsCollected) {
                    itemsCollected = { ...itemsCollected, ...data.itemsCollected };
                }
                if (data.collectedGems !== undefined) {
                    collectedGems = data.collectedGems;
                }
                if (data.totalGemsCollected !== undefined) {
                    totalGemsCollected = data.totalGemsCollected;
                }
                if (data.batsHit !== undefined) {
                    batsHit = data.batsHit;
                }
                
                updateDisplay();
                updateItemDisplay(); // Update the items display with loaded data
            } catch (error) {
                console.error('Error loading game data:', error);
                showMessage('     ', 'error');
                // Fallback to default values if loading fails
                score = 1000;
                highScore = 1000;
                roundNumber = 1;
                updateDisplay();
            }
        }

        async function saveUserData() {
            const token = localStorage.getItem('token');
            if (!token) {
                console.error('No token found, user is not logged in.');
                return; 
            }

            // Use the global variables directly instead of reading from the DOM
            const dataToSave = { 
                score, 
                highScore, 
                roundNumber,
                itemsCollected,
                collectedGems,
                totalGemsCollected,
                batsHit
            };
            console.log('Attempting to save user data:', dataToSave);

            try {
                const response = await fetch(`${BACKEND_URL}/api/users/save-game-data`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(dataToSave)
                });

                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        localStorage.removeItem('token');
                        localStorage.removeItem('username');
                        window.location.href = 'index.html';
                    }
                    throw new Error(`Server responded with ${response.status}`);
                }
                const data = await response.json();
                // The server should return the updated data, but we can also just trust our local state was saved.
                console.log('User data saved successfully.');

            } catch (error) {
                // This error is expected if the user navigates away while a save is in progress.
                // navigator.sendBeacon will handle the final save.
                if (error.name === 'TypeError' && error.message === 'Failed to fetch') {
                    console.warn('Fetch was cancelled by page navigation. Beacon will save data.');
                } else {
                    console.error('Error saving game data:', error);
                    showMessage('     ', 'error');
                }
            }
        }

        // Add this event listener to save data when the user leaves the page
        window.addEventListener('beforeunload', (event) => {
            const token = localStorage.getItem('token');
            if (!token) return;

            const dataToSave = { 
                score, 
                highScore, 
                roundNumber,
                itemsCollected,
                collectedGems,
                totalGemsCollected,
                batsHit
            };
            const blob = new Blob([JSON.stringify(dataToSave)], { type: 'application/json' });
            
            // Use sendBeacon for reliable data sending on unload
            navigator.sendBeacon(`${BACKEND_URL}/api/users/save-game-data?token=${token}`, blob);
        });

        async function animateHeroAndOpenBox(betType) {
            const boxes = Array.from(document.querySelectorAll('.box:not(.opened)'));
            if (boxes.length === 0) {
                showMessage('  !', 'error');
                return null;
            }

            let boxesToOpenCount = 1;
            if (betType === 'triple') boxesToOpenCount = 3;
            if (betType === 'hammer') boxesToOpenCount = 5;

            if (boxes.length < boxesToOpenCount) {
                showMessage('     !', 'error');
                return null;
            }

            seekerImage.style.display = 'block';
            seekerImage.style.left = '50%';
            seekerImage.style.top = '110%';
            await sleep(200);

            const shuffledBoxes = boxes.sort(() => 0.5 - Math.random());
            const targets = shuffledBoxes.slice(0, boxesToOpenCount);

            for (let i = 0; i < shuffledBoxes.length; i++) {
                const box = shuffledBoxes[i];
                const boxRect = box.getBoundingClientRect();
                const gridRect = boxesContainer.getBoundingClientRect();
                const targetX = boxRect.left - gridRect.left + boxRect.width / 2;
                const targetY = boxRect.top - gridRect.top + boxRect.height / 2;

                seekerImage.style.left = `${targetX}px`;
                seekerImage.style.top = `${targetY}px`;

                box.classList.add('sequential-glow');
                await sleep(250);
                box.classList.remove('sequential-glow');

                if (targets.includes(box) && boxesToOpenCount > 1) {
                    box.classList.add('single-shot-final-glow');
                }
            }

            const finalTarget = targets[targets.length - 1];
            finalTarget.classList.add('single-shot-final-glow');
            seekerImage.style.animation = 'finalSeekerPulse 1s infinite alternate';

            await sleep(2000);

            seekerImage.style.animation = 'none';

            targets.forEach(box => {
                box.classList.remove('single-shot-final-glow');
                box.classList.add('opened');
            });

            return targets;
        }

        async function placeBet(betType) {
            if (isProcessingShot) return;

            const bet = BETS[betType];
            if (score < bet.cost) {
                showMessage('   .   .', 'error');
                const controls = document.querySelector('.controls');
                controls.innerHTML = '<button id="recharge-button" class="bet-button" style="background-color: #007bff;"> </button>';
                document.getElementById('recharge-button').addEventListener('click', () => {
                    window.location.href = 'index.html';
                });
                return;
            }

            // Play the correct sound for the bet type
            if (betType === 'single') {
                sounds.singleShot.play().catch(e => console.log('Single shot sound error:', e));
            } else if (betType === 'triple') {
                sounds.tripleShot.play().catch(e => console.log('Triple shot sound error:', e));
            } else if (betType === 'hammer') {
                sounds.hammerShot.play().catch(e => {
                    console.log('Hammer shot sound error:', e);
                    // Fallback to button click sound if hammer sound fails
                    sounds.buttonClick.play().catch(e2 => console.log('Button click fallback error:', e2));
                });
            }
            
            isProcessingShot = true;
            score -= bet.cost;
            updateDisplay();
            createBoxes();

            showMessage(`...${username}     `, '');
            
            const openedBoxes = await animateHeroAndOpenBox(betType);

            if (!openedBoxes || openedBoxes.length === 0) {
                isProcessingShot = false;
                updateDisplay();
                return;
            }

            let totalWinAmount = 0;
            let wins = 0;

            openedBoxes.forEach(box => {
                const boxContent = box.querySelector('.box-content');
                const boxText = boxContent.querySelector('.box-text');
                const coinIcon = boxContent.querySelector('.coin-icon');
                const itemIcon = boxContent.querySelector('.item-icon');

                // Determine box type based on bet type
                let boxType = determineBoxType(betType);
                
                // Process box based on its type
                const result = processBox(boxType, bet, openedBoxes.length);
                
                // Update box display
                if (result.hasCoins) {
                    const winAmount = result.coinAmount;
                    totalWinAmount += winAmount;
                    score += winAmount;
                    boxText.textContent = ` ${Math.round(winAmount)}`;
                    coinIcon.style.display = 'block';
                    box.style.backgroundColor = '#28a745';
                    box.style.border = '3px solid #20c997';
                    wins++;
                } else if (result.hasItem) {
                    const itemData = ITEM_REWARDS[result.item];
                    itemIcon.textContent = itemData.emoji;
                    itemIcon.style.display = 'block';
                    itemIcon.style.fontSize = '1.5em';
                    
                    // Add special effects for negative items
                    if (itemData.points < 0) {
                        itemIcon.style.animation = 'negativeItemShake 0.5s ease-in-out';
                        itemIcon.style.filter = 'drop-shadow(0 0 10px #ef4444)';
                        sounds.lose.play().catch(e => console.log('Negative item appearance sound error:', e));
                    }
                    
                    // Add item to collection
                    addItem(result.item);
                    
                    // Show item points with color coding
                    const pointsText = itemData.points >= 0 ? `+${itemData.points}` : `${itemData.points}`;
                    boxText.textContent = `${itemData.emoji} ${pointsText}`;
                    boxText.style.color = itemData.points >= 0 ? '#fff' : '#ff6b6b';
                    box.style.backgroundColor = itemData.points >= 0 ? '#17a2b8' : '#dc3545';
                    box.style.border = itemData.points >= 0 ? '3px solid #20c997' : '3px solid #ff6b6b';
                } else {
                    // Empty box
                    boxText.textContent = ' ';
                    boxText.style.color = '#6c757d';
                    coinIcon.style.display = 'none';
                    itemIcon.style.display = 'none';
                    box.style.backgroundColor = '#6c757d';
                    box.style.border = '3px solid #495057';
                }
            });

            if (wins > 0) {
                showMessage(`!  ${Math.round(totalWinAmount)}   ${wins} ! `, 'success');
                sounds.win.play();

                showWinEffect(Math.round(totalWinAmount));
                sounds.winGif.currentTime = 0;
                sounds.winGif.play();
                setTimeout(() => {
                    sounds.winGif.pause();
                    sounds.winGif.currentTime = 0;
                }, 4000);
                // Send fake congratulatory messages
                setTimeout(() => {
                    sendFakeCongratulations(Math.round(totalWinAmount));
                }, 1000); // Start after 1 second
            } else {
                // Check if any items were found
                const itemsFound = openedBoxes.some(box => {
                    const itemIcon = box.querySelector('.item-icon');
                    return itemIcon && itemIcon.style.display === 'block';
                });
                
                if (itemsFound) {
                    showMessage('        ! ', 'info');
                } else {
                    showMessage('    !    ', 'error');
                }
                
                sounds.lose.play();

                showLoseEffect(bet.cost);
                sounds.loseGif.currentTime = 0;
                sounds.loseGif.play();
                setTimeout(() => {
                    sounds.loseGif.pause();
                    sounds.loseGif.currentTime = 0;
                }, 3000);
                // Send fake loss reactions
                setTimeout(() => {
                    sendFakeLossReactions();
                }, 2000); // Start after 2 seconds
            }

            if (highScore < score) {
                highScore = score;
            }

            roundNumber++;
            updateDisplay();
            await saveUserData();

            isProcessingShot = false;
            updateDisplay(); // Re-enable buttons
        }

        // Event Listeners
        window.addEventListener('beforeunload', (event) => {
            if (isProcessingShot) {
                // Optionally, you can warn the user if they try to leave mid-game
                event.preventDefault();
                event.returnValue = '';
            } else {
                saveUserData();
            }
        });

        singleShotButton.addEventListener('click', () => placeBet('single'));
        tripleShotButton.addEventListener('click', () => placeBet('triple'));
        hammerShotButton.addEventListener('click', () => placeBet('hammer'));

        logoutButton.addEventListener('click', () => {
            sounds.buttonClick.play();
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            window.location.href = 'index.html';
        });

        rechargeButton.addEventListener('click', () => {
            sounds.buttonClick.play();
            window.location.href = 'index.html';
        });

        muteButton.addEventListener('click', () => {
            isMuted = !isMuted;
            Object.values(sounds).forEach(sound => sound.muted = isMuted);
            muteButton.textContent = isMuted ? '  ' : '  ';
        });

        // Chat functionality
        const chatContainer = document.getElementById('chatContainer');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendMessageBtn = document.getElementById('sendMessage');
        const toggleChatBtn = document.getElementById('toggleChat');
        const chatMuteBtn = document.getElementById('chatMuteBtn');
        const voiceChatBtn = document.getElementById('voiceChatBtn');
        const voiceChatStatus = document.getElementById('voiceChatStatus');
        const voiceModal = document.getElementById('voiceModal');
        const enableVoiceBtn = document.getElementById('enableVoiceBtn');
        const cancelVoiceBtn = document.getElementById('cancelVoiceBtn');
        const connectedPlayers = document.getElementById('connectedPlayers');

        // Emoji and Sound Keys
        const emojiBtn = document.getElementById('emojiBtn');
        const emojiPicker = document.getElementById('emojiPicker');
        const soundBtn = document.getElementById('soundBtn');
        const soundKeys = document.getElementById('soundKeys');

        // Chat audio elements
        const chatNotification = document.getElementById('chatNotification');
        const messageSent = document.getElementById('messageSent');

        let isChatCollapsed = false;
        let isVoiceChatActive = false;
        let mediaStream = null;
        let peerConnections = {};
        let ws; // WebSocket connection

        // Message deduplication
        const sentMessages = new Set();
        const messageTimeout = 5000; // 5 seconds

        function connectWebSocket() {
            try {
                // Use wss:// for secure production environment
                const wsUrl = `wss://mygame25bita.onrender.com`;
                console.log('Attempting to connect to WebSocket:', wsUrl);
                
                ws = new WebSocket(wsUrl);

                ws.onopen = () => {
                    console.log(' WebSocket connection established successfully');
                    addMessageToChat('', '   .', 'system-message');
                    // Announce that this user has joined
                    if (username) {
                        ws.send(JSON.stringify({ type: 'join', username: username }));
                        console.log('Sent join message for user:', username);
                    }
                };

                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        console.log(' WebSocket message received:', data);

                        if (data.type === 'chat_message') {
                            // Check if this is a duplicate message
                            if (data.messageId && sentMessages.has(data.messageId)) {
                                console.log(' Duplicate message detected, skipping:', data.messageId);
                                return;
                            }
                            
                            // Add message ID to sent messages set if it exists
                            if (data.messageId) {
                                sentMessages.add(data.messageId);
                            }
                            
                            // Determine message type based on sender
                            const messageType = data.sender === username ? 'own' : 'other';
                            addMessageToChat(data.sender, data.text, messageType);
                            
                            // Play notification sound only for messages from others
                            if (messageType === 'other') {
                                playChatSound(chatNotification);
                            }
                        } else if (data.type === 'player_joined') {
                            addMessageToChat('', `  ${data.username}  `, 'system-message');
                        } else if (data.type === 'player_left') {
                             addMessageToChat('', `  ${data.username} `, 'system-message');
                        } else if (data.type === 'ping') {
                            // Respond to ping with pong
                            ws.send(JSON.stringify({ type: 'pong' }));
                        }
                    } catch (error) {
                        console.error(' Error parsing WebSocket message:', error);
                    }
                };

                ws.onclose = (event) => {
                    console.log(' WebSocket connection closed:', event.code, event.reason);
                    addMessageToChat('', ' .   ...', 'system-message');
                    
                    // Try to reconnect after 3 seconds
                    setTimeout(() => {
                        console.log(' Attempting to reconnect WebSocket...');
                        connectWebSocket();
                    }, 3000);
                };

                ws.onerror = (error) => {
                    console.error(' WebSocket error:', error);
                    addMessageToChat('', '    .', 'system-message error');
                };

                // Set a timeout for connection
                setTimeout(() => {
                    if (ws.readyState !== WebSocket.OPEN) {
                        console.warn(' WebSocket connection timeout');
                        addMessageToChat('', '   .    .', 'system-message error');
                    }
                }, 5000);

            } catch (error) {
                console.error(' Error creating WebSocket connection:', error);
                addMessageToChat('', '    .', 'system-message error');
            }
        }

        // Function to check WebSocket status
        function checkWebSocketStatus() {
            if (!ws) {
                console.log(' WebSocket not initialized');
                return false;
            }
            
            const states = {
                0: 'CONNECTING',
                1: 'OPEN',
                2: 'CLOSING',
                3: 'CLOSED'
            };
            
            const state = states[ws.readyState] || 'UNKNOWN';
            console.log(` WebSocket status: ${state} (${ws.readyState})`);
            
            return ws.readyState === WebSocket.OPEN;
        }

        // Function to manually reconnect WebSocket
        function reconnectWebSocket() {
            console.log(' Manual WebSocket reconnection requested');
            if (ws) {
                ws.close();
            }
            setTimeout(connectWebSocket, 1000);
        }

        // Initialize chat audio
        chatNotification.volume = chatVolume;
        messageSent.volume = chatVolume;

        // Function to play chat sounds
        function playChatSound(audioElement) {
            if (!isChatMuted && audioElement) {
                audioElement.currentTime = 0;
                audioElement.play().catch(e => {
                    console.log('Chat sound play error:', e);
                });
            }
        }

        // Toggle chat mute
        chatMuteBtn.addEventListener('click', () => {
            isChatMuted = !isChatMuted;
            chatMuteBtn.classList.toggle('muted', isChatMuted);
            
            if (isChatMuted) {
                chatMuteBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
                chatMuteBtn.title = '   ';
            } else {
                chatMuteBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
                chatMuteBtn.title = '  ';
            }
        });

        // Toggle chat window
        toggleChatBtn.addEventListener('click', () => {
            isChatCollapsed = !isChatCollapsed;
            chatContainer.classList.toggle('collapsed', isChatCollapsed);
            
            if (isChatCollapsed) {
                toggleChatBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
            } else {
                toggleChatBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
            }
        });

        // Send message function
        function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;
            
            // Check WebSocket status first
            if (!checkWebSocketStatus()) {
                console.log(' Cannot send message, WebSocket is not open');
                addMessageToChat('', '   .   .', 'system-message error');
                return;
            }
            
            try {
                // Create unique message identifier
                const messageId = `${username}-${Date.now()}-${message}`;
                
                // Send the message through the WebSocket
                ws.send(JSON.stringify({
                    type: 'chat_message',
                    text: message,
                    sender: username,
                    messageId: messageId
                }));
                
                console.log(' Message sent successfully:', message);
                
                // Clear the input field
                chatInput.value = '';
                
                // Play sent message sound
                playChatSound(messageSent);
                
                // Clean up old message IDs after timeout
                setTimeout(() => {
                    sentMessages.delete(messageId);
                }, messageTimeout);
                
            } catch (error) {
                console.error(' Error sending message:', error);
                addMessageToChat('', '   .', 'system-message error');
            }
        }

        // Add message to chat
        function addMessageToChat(sender, text, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${type}`;
            
            const time = new Date().toLocaleTimeString('ar-SA', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            messageDiv.innerHTML = `
                <div class="message-sender">${sender}</div>
                <div class="message-text">${text}</div>
                <div class="message-time">${time}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Add animation for new messages
            messageDiv.style.opacity = '0';
            messageDiv.style.transform = 'translateY(10px)';
            setTimeout(() => {
                messageDiv.style.transition = 'all 0.3s ease';
                messageDiv.style.opacity = '1';
                messageDiv.style.transform = 'translateY(0)';
            }, 10);
        }

        // Send message on button click
        sendMessageBtn.addEventListener('click', sendMessage);

        // Send message on Enter key
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Emoji picker functionality
        emojiBtn.addEventListener('click', () => {
            emojiPicker.classList.toggle('show');
            soundKeys.classList.remove('show');
        });

        // Sound keys functionality
        soundBtn.addEventListener('click', () => {
            soundKeys.classList.toggle('show');
            emojiPicker.classList.remove('show');
        });

        // Emoji selection
        emojiPicker.addEventListener('click', (e) => {
            if (e.target.classList.contains('emoji-item')) {
                const emoji = e.target.textContent;
                chatInput.value += emoji;
                chatInput.focus();
                emojiPicker.classList.remove('show');
            }
        });

        // Sound key selection
        soundKeys.addEventListener('click', (e) => {
            if (e.target.classList.contains('sound-key')) {
                const soundType = e.target.dataset.sound;
                playSoundKey(soundType);
                soundKeys.classList.remove('show');
            }
        });

        // Close pickers when clicking outside
        document.addEventListener('click', (e) => {
            if (!emojiBtn.contains(e.target) && !emojiPicker.contains(e.target)) {
                emojiPicker.classList.remove('show');
            }
            if (!soundBtn.contains(e.target) && !soundKeys.contains(e.target)) {
                soundKeys.classList.remove('show');
            }
        });

        // Function to play sound keys
        function playSoundKey(soundType) {
            if (isMuted) return;
            
            switch(soundType) {
                case 'win':
                    sounds.win.currentTime = 0;
                    sounds.win.play().catch(e => console.log('Sound key error:', e));
                    break;
                case 'lose':
                    sounds.lose.currentTime = 0;
                    sounds.lose.play().catch(e => console.log('Sound key error:', e));
                    break;
                case 'click':
                    sounds.buttonClick.currentTime = 0;
                    sounds.buttonClick.play().catch(e => console.log('Sound key error:', e));
                    break;
                case 'single':
                    sounds.singleShot.currentTime = 0;
                    sounds.singleShot.play().catch(e => console.log('Sound key error:', e));
                    break;
                case 'triple':
                    sounds.tripleShot.currentTime = 0;
                    sounds.tripleShot.play().catch(e => console.log('Sound key error:', e));
                    break;
                case 'hammer':
                    sounds.hammerShot.currentTime = 0;
                    sounds.hammerShot.play().catch(e => console.log('Sound key error:', e));
                    break;
            }
        }

        // Reconnect WebSocket button
        document.getElementById('reconnectBtn').addEventListener('click', () => {
            reconnectWebSocket();
            addMessageToChat('', '  ...', 'system-message');
        });

        // Auto-focus chat input when chat is opened
        toggleChatBtn.addEventListener('click', () => {
            if (!isChatCollapsed) {
                setTimeout(() => chatInput.focus(), 300);
            }
        });

        // Update chat volume when main mute changes
        muteButton.addEventListener('click', () => {
            isMuted = !isMuted;
            Object.values(sounds).forEach(sound => sound.muted = isMuted);
            chatNotification.muted = isMuted;
            messageSent.muted = isMuted;
            muteButton.textContent = isMuted ? '  ' : '  ';
        });

        // Voice Chat Functions
        function showVoiceModal() {
            voiceModal.classList.add('show');
        }

        function hideVoiceModal() {
            voiceModal.classList.remove('show');
        }

        async function enableVoiceChat() {
            try {
                // Request microphone permission
                mediaStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: true, 
                    video: false 
                });
                
                isVoiceChatActive = true;
                voiceChatBtn.classList.add('voice-active');
                voiceChatBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                voiceChatBtn.title = '  ';
                voiceChatStatus.style.display = 'block';
                
                hideVoiceModal();
                
                // Simulate connected players (for demo)
                updateConnectedPlayers(3);
                
                // Start voice chat simulation
                startVoiceChatSimulation();
                
                console.log('Voice chat enabled successfully');
            } catch (error) {
                console.error('Error enabling voice chat:', error);
                alert('   .     .');
                hideVoiceModal();
            }
        }

        function disableVoiceChat() {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            
            isVoiceChatActive = false;
            voiceChatBtn.classList.remove('voice-active');
            voiceChatBtn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
            voiceChatBtn.title = '  ';
            voiceChatStatus.style.display = 'none';
            
            // Clear peer connections
            Object.values(peerConnections).forEach(pc => pc.close());
            peerConnections = {};
            
            console.log('Voice chat disabled');
        }

        function updateConnectedPlayers(count) {
            connectedPlayers.innerHTML = `<span> : ${count}</span>`;
        }

        function startVoiceChatSimulation() {
            // Simulate voice activity
            setInterval(() => {
                if (isVoiceChatActive) {
                    const voiceIndicator = document.querySelector('.voice-indicator');
                    if (Math.random() > 0.7) { // 30% chance of voice activity
                        voiceIndicator.classList.add('recording');
                        setTimeout(() => {
                            voiceIndicator.classList.remove('recording');
                        }, 1000 + Math.random() * 2000);
                    }
                }
            }, 3000);
        }

        // Voice Chat Event Listeners
        voiceChatBtn.addEventListener('click', () => {
            if (!isVoiceChatActive) {
                showVoiceModal();
            } else {
                disableVoiceChat();
            }
        });

        enableVoiceBtn.addEventListener('click', enableVoiceChat);
        cancelVoiceBtn.addEventListener('click', hideVoiceModal);

        // Close modal when clicking outside
        voiceModal.addEventListener('click', (e) => {
            if (e.target === voiceModal) {
                hideVoiceModal();
            }
        });

        // Initialize the game
        async function initGame() {
            username = localStorage.getItem('username');
            if (!username) {
                window.location.href = 'index.html';
                return;
            }

            await loadGameData();
            createBoxes();
            initializeItemDisplay(); // Initialize item display
            initializeItemInfoModal(); // Initialize item info modal
            updateDisplay();
            checkAudioFiles();
            connectWebSocket();
        }

        // Start the game
        initGame();

        // Initialize Voice Chat
        const voiceMicBtn = document.getElementById('voice-mic-btn');
        const voiceStatus = document.getElementById('voice-status');
        
        //  Voice Chat Manager   
        if (window.voiceChatManager) {
            window.voiceChatManager.setUIElements(voiceMicBtn, voiceStatus);
        }
        
        // Voice Chat Button Event
        voiceMicBtn.addEventListener('click', async () => {
            if (!username) {
                showMessage('   ', 'error');
                return;
            }
            
            try {
                if (!window.voiceChatManager.isJoined) {
                    //   
                    const success = await window.voiceChatManager.joinVoiceChat(username);
                    if (success) {
                        showMessage('    ! ', 'success');
                    } else {
                        showMessage('    ', 'error');
                    }
                } else {
                    //   
                    await window.voiceChatManager.leaveVoiceChat();
                    showMessage('   ', 'info');
                }
            } catch (error) {
                console.error('Voice chat error:', error);
                showMessage('    ', 'error');
            }
        });
        
        // Mute/Unmute Voice Chat (Right click)
        voiceMicBtn.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            if (window.voiceChatManager && window.voiceChatManager.isJoined) {
                window.voiceChatManager.toggleMute();
            }
        });

        // Function to send fake congratulatory messages
        function sendFakeCongratulations(winAmount) {
            const fakeUsers = [
                '_',
                '_',
                '_',
                '_',
                '_',
                '_',
                '_',
                '_'
            ];
            
            const congratulations = [
                `!  ${winAmount}  `,
                `!    ${winAmount}  `,
                `  ! ${winAmount}   `,
                `! ${winAmount}     `,
                ` ! ${winAmount}   `,
                ` ! ${winAmount}   `,
                `  ! ${winAmount}  `,
                `! ${winAmount}    `
            ];
            
            // Send 2-4 congratulatory messages
            const numMessages = Math.floor(Math.random() * 3) + 2; // 2-4 messages
            
            for (let i = 0; i < numMessages; i++) {
                setTimeout(() => {
                    const randomUser = fakeUsers[Math.floor(Math.random() * fakeUsers.length)];
                    const randomCongratulation = congratulations[Math.floor(Math.random() * congratulations.length)];
                    
                    // Add the fake message to chat
                    addMessageToChat(randomUser, randomCongratulation, 'other');
                    
                    // Play notification sound
                    playChatSound(chatNotification);
                    
                    console.log(` Fake message from ${randomUser}: ${randomCongratulation}`);
                }, (i + 1) * 2000); // Send messages with 2-second intervals
            }
        }

        // Function to send fake reactions to losses
        function sendFakeLossReactions() {
            const fakeUsers = [
                '_',
                '_',
                '_',
                '_',
                '_',
                '_',
                '_',
                '_'
            ];
            
            const lossReactions = [
                '      ! ',
                '     ! ',
                '     ! ',
                '    ! ',
                '     ! ',
                '    ! ',
                '    ! ',
                '     ! '
            ];
            
            // Send 1-2 encouraging messages
            const numMessages = Math.floor(Math.random() * 2) + 1; // 1-2 messages
            
            for (let i = 0; i < numMessages; i++) {
                setTimeout(() => {
                    const randomUser = fakeUsers[Math.floor(Math.random() * fakeUsers.length)];
                    const randomReaction = lossReactions[Math.floor(Math.random() * lossReactions.length)];
                    
                    // Add the fake message to chat
                    addMessageToChat(randomUser, randomReaction, 'other');
                    
                    // Play notification sound
                    playChatSound(chatNotification);
                    
                    console.log(` Fake loss reaction from ${randomUser}: ${randomReaction}`);
                }, (i + 1) * 3000); // Send messages with 3-second intervals
            }
        }

        // Item Info Modal Functions
        function initializeItemInfoModal() {
            const modal = document.getElementById('itemInfoModal');
            const openBtn = document.getElementById('itemInfoBtn');
            const closeBtn = document.getElementById('itemInfoClose');
            
            openBtn.addEventListener('click', () => {
                populateItemInfoModal();
                modal.classList.add('show');
            });
            
            closeBtn.addEventListener('click', () => {
                modal.classList.remove('show');
            });
            
            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('show');
                }
            });
        }

        function populateItemInfoModal() {
            const itemInfoGrid = document.getElementById('itemInfoGrid');
            const collectionGoalsList = document.getElementById('collectionGoalsList');
            
            // Clear previous content
            itemInfoGrid.innerHTML = '';
            collectionGoalsList.innerHTML = '';
            
            // Add item cards
            Object.entries(ITEM_REWARDS).forEach(([itemType, itemData]) => {
                const itemCard = document.createElement('div');
                itemCard.className = 'item-info-card';
                
                const pointsClass = itemData.points >= 0 ? 'positive' : 'negative';
                const pointsText = itemData.points >= 0 ? `+${itemData.points}` : `${itemData.points}`;
                
                itemCard.innerHTML = `
                    <div class="item-info-emoji">${itemData.emoji}</div>
                    <div class="item-info-details">
                        <div class="item-info-name">${itemData.name}</div>
                        <div class="item-info-description">${getItemDescription(itemType)}</div>
                        <div class="item-info-points ${pointsClass}">${pointsText} </div>
                    </div>
                `;
                
                itemInfoGrid.appendChild(itemCard);
            });
            
            // Add collection goals
            Object.entries(COLLECTION_GOALS).forEach(([itemType, goal]) => {
                const itemData = ITEM_REWARDS[itemType];
                if (!itemData) return; // Skip if not defined
                const goalItem = document.createElement('div');
                goalItem.className = 'collection-goal-item';
                
                goalItem.innerHTML = `
                    <div class="collection-goal-info">
                        <div class="collection-goal-emoji">${itemData.emoji}</div>
                        <div class="collection-goal-text"> ${goal.target} ${goal.name}</div>
                    </div>
                    <div class="collection-goal-reward">+${goal.reward} </div>
                `;
                
                collectionGoalsList.appendChild(goalItem);
            });
        }

        function getItemDescription(itemType) {
            const descriptions = {
                gem: '    .  5     !',
                key: '    .  3    !',
                coin: '    .      !',
                bomb: ' !    .  !',
                star: '    .     !',
                bat: '    .  !'
            };
            
            return descriptions[itemType] || '   .';
        }

        // Initialize everything
        document.addEventListener('DOMContentLoaded', function() {
            // The game is already initialized with initGame() call above
            // Just initialize the additional features
            initializeItemInfoModal();
            
            // Uncomment the line below to test effects on page load
            // testEffects();
        });

        // Close win/loss containers on close button click
        document.getElementById('closeWinGif').onclick = function() {
            document.getElementById('win-gif-container').style.display = 'none';
        };
        document.getElementById('closeSadcatGif').onclick = function() {
            document.getElementById('sadcat-gif-container').style.display = 'none';
        };

        function showWinEffect(amount) {
            console.log(' Showing win effect for amount:', amount);
            const winGifContainer = document.getElementById('win-gif-container');
            const winAmountDisplay = document.getElementById('win-amount-display');
            const winAmountText = document.getElementById('win-amount-text');
            
            if (!winGifContainer) {
                console.error(' Win GIF container not found!');
                return;
            }
            
            // Show the container
            winGifContainer.style.display = 'flex';
            winGifContainer.style.opacity = '1';
            winGifContainer.style.visibility = 'visible';
            
            // Show amount display
            if (winAmountDisplay && winAmountText) {
                winAmountText.textContent = `+${amount}`;
                winAmountDisplay.style.display = 'block';
                winAmountDisplay.style.opacity = '1';
                console.log(' Win amount display updated:', `+${amount}`);
            }
            
            // Hide after 4 seconds
            setTimeout(() => {
                winGifContainer.style.display = 'none';
                if (winAmountDisplay) {
                    winAmountDisplay.style.display = 'none';
                }
                console.log(' Win effect hidden');
            }, 4000);
        }

        function showLoseEffect(amount) {
            console.log(' Showing lose effect for amount:', amount);
            const sadcatGifContainer = document.getElementById('sadcat-gif-container');
            const loseAmountDisplay = document.getElementById('lose-amount-display');
            const loseAmountText = document.getElementById('lose-amount-text');
            
            if (!sadcatGifContainer) {
                console.error(' Sadcat GIF container not found!');
                return;
            }
            
            // Show the container
            sadcatGifContainer.style.display = 'flex';
            sadcatGifContainer.style.opacity = '1';
            sadcatGifContainer.style.visibility = 'visible';
            
            // Show amount display
            if (loseAmountDisplay && loseAmountText) {
                loseAmountText.textContent = `-${amount}`;
                loseAmountDisplay.style.display = 'block';
                loseAmountDisplay.style.opacity = '1';
                console.log(' Lose amount display updated:', `-${amount}`);
            }
            
            // Hide after 3 seconds
            setTimeout(() => {
                sadcatGifContainer.style.display = 'none';
                if (loseAmountDisplay) {
                    loseAmountDisplay.style.display = 'none';
                }
                console.log(' Lose effect hidden');
            }, 3000);
        }

        // Test function to verify effects are working
        function testEffects() {
            console.log(' Testing win/lose effects...');
            
            // Test win effect
            setTimeout(() => {
                console.log(' Testing win effect...');
                showWinEffect(1000);
            }, 1000);
            
            // Test lose effect
            setTimeout(() => {
                console.log(' Testing lose effect...');
                showLoseEffect(500);
            }, 6000);
        }

        // Function to determine box type based on bet type
        function determineBoxType(betType) {
            const random = Math.random();
            
            if (betType === 'single') {
                // Single shot: 40% coins only, 30% items only, 20% both, 10% empty
                if (random < 0.4) return 'coins_only';
                else if (random < 0.7) return 'items_only';
                else if (random < 0.9) return 'both';
                else return 'empty';
            } else if (betType === 'triple') {
                // Triple shot: 35% coins only, 35% items only, 25% both, 5% empty
                if (random < 0.35) return 'coins_only';
                else if (random < 0.7) return 'items_only';
                else if (random < 0.95) return 'both';
                else return 'empty';
            } else if (betType === 'hammer') {
                // Hammer shot: 25% coins only, 40% items only, 30% both, 5% empty
                if (random < 0.25) return 'coins_only';
                else if (random < 0.65) return 'items_only';
                else if (random < 0.95) return 'both';
                else return 'empty';
            }
            
            return 'coins_only'; // Default fallback
        }

        // Function to process box content based on type
        function processBox(boxType, bet, numBoxes) {
            const result = {
                hasCoins: false,
                hasItem: false,
                coinAmount: 0,
                item: null
            };

            switch (boxType) {
                case 'coins_only':
                    // Box contains only coins (no items)
                    const winChance = 0.4; // 40% chance to win
                    if (Math.random() < winChance) {
                        result.hasCoins = true;
                        result.coinAmount = bet.cost * bet.multiplier / numBoxes;
                    }
                    break;
                    
                case 'items_only':
                    // Box contains only items (no coins)
                    const itemChance = 0.8; // 80% chance to find item
                    if (Math.random() < itemChance) {
                        result.hasItem = true;
                        result.item = generateRandomItem();
                    }
                    break;
                    
                case 'both':
                    // Box can contain both coins and items
                    const coinWinChance = 0.3; // 30% chance to win coins
                    const itemChance2 = 0.7; // 70% chance to find item
                    
                    if (Math.random() < coinWinChance) {
                        result.hasCoins = true;
                        result.coinAmount = bet.cost * bet.multiplier / numBoxes;
                    }
                    
                    if (Math.random() < itemChance2) {
                        result.hasItem = true;
                        result.item = generateRandomItem();
                    }
                    break;
                    
                case 'empty':
                    // Box is completely empty
                    // 5% chance to find something anyway (lucky find)
                    const luckyChance = 0.05;
                    if (Math.random() < luckyChance) {
                        if (Math.random() < 0.5) {
                            result.hasCoins = true;
                            result.coinAmount = bet.cost * 0.5 / numBoxes; // Reduced amount
                        } else {
                            result.hasItem = true;
                            result.item = generateRandomItem();
                        }
                    }
                    break;
            }

            return result;
        }

        // Event Listeners
    </script>
</body>
</html>


