<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoiceBoom Game</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Amiri&family=Scheherazade+New:wght@400;700&family=Noto+Naskh+Arabic:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="mobile-optimization.css">
    <link rel="stylesheet" href="box-styles.css">
    <link rel="stylesheet" href="game-styles.css">
</head>
<body>
    <!-- ุฒุฑ ุงููุถุน ุงููููู -->
    <button id="darkModeToggle" title="ุชุจุฏูู ุงููุถุน ุงููููู/ุงููุงุชุญ">๐</button>
    <!-- ุฒุฑ ุบุฑูุฉ ุงููุญุงุฏุซุฉ ุงูุตูุชูุฉ -->
    <button onclick="window.open('voice-chat-room.html', '_blank')" 
        style="
            position: fixed;
            bottom: 30px;
            left: 30px;
            z-index: 9999;
            background: linear-gradient(135deg, #7fbcff 0%, #4f46e5 100%);
            color: #fff;
            border: none;
            border-radius: 50px;
            box-shadow: 0 4px 16px rgba(79,70,229,0.18);
            font-size: 1.2em;
            font-family: 'Cairo', 'Noto Naskh Arabic', sans-serif;
            padding: 18px 32px;
            cursor: pointer;
            font-weight: bold;
            letter-spacing: 1px;
            transition: background 0.2s, transform 0.2s;
        "
        onmouseover="this.style.background='linear-gradient(135deg, #f43f5e 0%, #facc15 100%)'"
        onmouseout="this.style.background='linear-gradient(135deg, #7fbcff 0%, #4f46e5 100%)'"
    >
        ๐ค ุบุฑูุฉ ุงููุญุงุฏุซุฉ ุงูุตูุชูุฉ
    </button>
    <div class="main-content">
        <!-- ุนููุฏ ุงูุฑุณุงุฆู (ูููู) -->
        <div class="messages-column">
            <div class="message-area" id="message-area"></div>
        </div>
        <!-- ุนููุฏ ุงููุนุจุฉ (ูุณุท) -->
        <div class="game-center-column">
            <div class="header-container">
                <div class="centered-header-content">
                    <img src="logo.png" alt="ุดุนุงุฑ ุงููุนุจุฉ" class="logo small-logo">
                </div>
            </div>
            <div class="controls circular-controls">
                <button id="single-shot-button" class="bet-button circular-btn" title="ุถุฑุจุฉ ูุฑุฏูุฉ">
                    <i class="fas fa-crosshairs"></i>
                </button>
                <button id="triple-shot-button" class="bet-button circular-btn" title="ุถุฑุจุฉ ุซูุงุซูุฉ">
                    <i class="fas fa-bullseye"></i>
                </button>
                <button id="hammer-shot-button" class="bet-button circular-btn" title="ุถุฑุจุฉ ุงููุทุฑูุฉ">
                    <i class="fas fa-hammer"></i>
                </button>
            </div>
            <div class="item-collection-display large-items" id="itemCollectionDisplay">
                <div class="item-collection-title">
                    ๐ฏ ุงูุนูุงุตุฑ ุงููุฌูุนุฉ
                    <button id="itemInfoBtn" class="item-info-btn" title="ูุนูููุงุช ุงูุนูุงุตุฑ">
                        <i class="fas fa-info-circle"></i>
                    </button>
                </div>
                <div class="items-grid" id="itemsGrid"></div>
                <div class="collection-reward" id="collectionReward" style="display: none;">
                    ๐ ููุงูุฃุฉ ุงููุฌููุนุฉ!
                </div>
            </div>
            <div class="boxes-grid prominent-boxes" id="boxes-container"></div>
            <div id="seeker-hero"></div>
        </div>
        <!-- ุนููุฏ ูุนูููุงุช ุงููุณุชุฎุฏู ูุงููุญุงุฏุซุฉ (ูุณุงุฑ) -->
        <div class="left-panel">
    <div class="player-info">
        <div class="player-details">
            <p><span id="username-display"></span></p>
            <p><span id="balance-display"></span>๐ฐ</p>
                    <p><span id="pearl-balance"></span>๐ฆช</p>
        </div>
        <div class="player-actions">
            <button id="recharge-button" title="ุชุนุจุฆุฉ ุฑุตูุฏ">๐ฐ</button>
                    <button id="lamp-button" title="ูุชุญ ุงููุตุจุงุญ">๐ก</button>
            <button id="logout-button" title="ุชุณุฌูู ุงูุฎุฑูุฌ">โป</button>
            <button id="mute-button" title="ูุชู/ุฅูุบุงุก ูุชู ุงูุตูุช">๐</button>
            <button id="friendsBtn" title="ุฅุฏุงุฑุฉ ุงูุฃุตุฏูุงุก">๐ฅ</button>
            <button id="dailyQuestsBtn" title="ุงูููุงู ุงูููููุฉ">๐</button>
            <button id="inviteBtn" title="ูุธุงู ุงูุฏุนูุงุช">๐</button>
        </div>
    </div>
        <div class="chat-container" id="chatContainer">
            <div class="chat-header">
                <h3><i class="fas fa-comments"></i> ุงููุญุงุฏุซุฉ</h3>
                <div class="chat-controls">
                    <button id="reconnectBtn" class="chat-control-btn" title="ุฅุนุงุฏุฉ ุงูุงุชุตุงู" style="background: linear-gradient(135deg, #10b981, #059669);">
                        <i class="fas fa-wifi"></i>
                    </button>
                    <button id="voiceChatBtn" class="chat-control-btn" title="ุจุฏุก ุงููุญุงุฏุซุฉ ุงูุตูุชูุฉ">
                        <i class="fas fa-microphone-slash"></i>
                    </button>
                    <button id="chatMuteBtn" class="chat-control-btn" title="ูุชู ุตูุช ุงููุญุงุฏุซุฉ">
                        <i class="fas fa-volume-up"></i>
                    </button>
                    <button id="toggleChat" class="chat-toggle-btn">
                        <i class="fas fa-chevron-right"></i>
                    </button>
            </div>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="system-message">
                    <span class="message-time">ุงูุขู</span>
                    <span class="message-text">ูุฑุญุจุงู! ููููู ุงูุชุญุฏุซ ูุน ุงููุงุนุจูู ุงูุขุฎุฑูู ููุง</span>
                </div>
            </div>
            <div class="voice-chat-status" id="voiceChatStatus" style="display: none;">
                <div class="voice-indicator">
                    <i class="fas fa-microphone"></i>
                    <span>ุงููุญุงุฏุซุฉ ุงูุตูุชูุฉ ูุดุทุฉ</span>
                </div>
                <div class="connected-players" id="connectedPlayers">
                    <span>ุงููุงุนุจูู ุงููุชุตููู: 0</span>
                </div>
            </div>
            <div class="chat-input-container">
                <div class="chat-controls-row" style="position: relative;">
                        <button id="emojiBtn" class="emoji-btn" title="ุฅุถุงูุฉ ุฑูุฒ ุชุนุจูุฑู">๐</button>
                    <div id="emojiPicker" class="emoji-picker">
                        <div class="emoji-item">๐</div>
                        <div class="emoji-item">๐</div>
                        <div class="emoji-item">๐</div>
                        <div class="emoji-item">๐</div>
                        <div class="emoji-item">๐ฐ</div>
                        <div class="emoji-item">๐ฎ</div>
                        <div class="emoji-item">๐ฅ</div>
                        <div class="emoji-item">โญ</div>
                        <div class="emoji-item">๐ช</div>
                        <div class="emoji-item">๐ฏ</div>
                        <div class="emoji-item">๐</div>
                        <div class="emoji-item">๐ฅณ</div>
                        <div class="emoji-item">๐</div>
                        <div class="emoji-item">๐คฉ</div>
                        <div class="emoji-item">๐</div>
                        <div class="emoji-item">๐ช</div>
                        <div class="emoji-item">๐จ</div>
                        <div class="emoji-item">๐</div>
                        <div class="emoji-item">โจ</div>
                        <div class="emoji-item">๐</div>
                        <div class="emoji-item">๐ญ</div>
                        <div class="emoji-item">๐ช</div>
                        <div class="emoji-item">๐ฏ</div>
        </div>
    </div>
                <div class="chat-controls-row" style="position: relative;">
                        <button id="soundBtn" class="sound-btn" title="ููุงุชูุญ ุงูุตูุช">๐</button>
                    <div id="soundKeys" class="sound-keys">
                        <div class="sound-key" data-sound="win">๐ ููุฒ</div>
                        <div class="sound-key" data-sound="lose">๐ข ุฎุณุงุฑุฉ</div>
                        <div class="sound-key" data-sound="click">๐ ููุฑุฉ</div>
                        <div class="sound-key" data-sound="single">๐ฏ ุถุฑุจุฉ ูุฑุฏูุฉ</div>
                        <div class="sound-key" data-sound="triple">๐ฏ ุถุฑุจุฉ ุซูุงุซูุฉ</div>
                        <div class="sound-key" data-sound="hammer">๐จ ุถุฑุจุฉ ุงููุทุฑูุฉ</div>
            </div>
            </div>
                <input type="text" id="chatInput" placeholder="ุงูุชุจ ุฑุณุงูุชู ููุง..." maxlength="100">
                <button id="sendMessage" class="send-btn">
                    <i class="fas fa-paper-plane"></i>
                </button>
                </div>
            </div>
        </div>
    </div>

    <div id="loading-indicator">ุฌุงุฑู ุญูุธ ุงูุจูุงูุงุช...</div>

    <!-- Voice Chat Modal -->
    <div class="voice-modal" id="voiceModal">
        <div class="voice-modal-content">
            <h3><i class="fas fa-microphone"></i> ุงููุญุงุฏุซุฉ ุงูุตูุชูุฉ</h3>
            <p>ูุจุฏุก ุงููุญุงุฏุซุฉ ุงูุตูุชูุฉุ ูุญุชุงุฌ ุฅูู ุฅุฐู ุงููุตูู ูููุงููุฑูููู</p>
            <button id="enableVoiceBtn" class="voice-permission-btn">
                <i class="fas fa-microphone"></i> ุชูุนูู ุงููุงููุฑูููู
            </button>
            <button id="cancelVoiceBtn" class="voice-permission-btn" style="background: #6b7280;">
                ุฅูุบุงุก
            </button>
        </div>
    </div>

    <div id="win-gif-container">
        <button class="close-btn" id="closeWinGif">ร</button>
        <img src="WIN.GIF" alt="Win GIF">
        <div id="win-amount-display" style="display: none;">
            <span id="win-amount-text"></span>
        </div>
    </div>

    <div id="sadcat-gif-container">
        <button class="close-btn" id="closeSadcatGif">ร</button>
        <img src="sadcat.gif" alt="Sadcat GIF">
        <div id="lose-amount-display" style="display: none;">
            <span id="lose-amount-text"></span>
        </div>
    </div>

    <audio id="winSound" src="win.mp3"></audio>
    <audio id="loseSound" src="lose.mp3"></audio>
    <audio id="buttonClick" src="click.mp3"></audio>
    <audio id="winGifSound" src="WIN1.MP3"></audio>
    <audio id="loseGifSound" src="lose.mp3"></audio>
    
    <!-- Chat Audio -->
    <audio id="chatNotification" src="sounds/click.mp3"></audio>
    <audio id="messageSent" src="click.mp3"></audio>

    <!-- Item Info Modal -->
    <div class="item-info-modal" id="itemInfoModal">
        <div class="item-info-content">
            <div class="item-info-header">
                <h2 class="item-info-title">๐ ุฏููู ุงูุนูุงุตุฑ</h2>
                <button class="item-info-close" id="itemInfoClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="item-info-grid" id="itemInfoGrid">
                <!-- Items will be generated by JavaScript -->
            </div>
            
            <div class="collection-goals-section">
                <h3 class="collection-goals-title">๐ฏ ุฃูุฏุงู ุงููุฌููุนุงุช</h3>
                <div class="collection-goals-list" id="collectionGoalsList">
                    <!-- Goals will be generated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <div class="player-stats-panel" style="margin: 30px 0;">
      <h3 style="text-align:center;">๐ ุฅุญุตุงุฆูุงุชู</h3>
      <canvas id="playerStatsChart" width="400" height="220" style="max-width:100%;background:#fff;border-radius:12px;"></canvas>
    </div>

    <!-- ูุงูุฐุฉ ููุจุซูุฉ ูุฅุฏุงุฑุฉ ุงูุฃุตุฏูุงุก -->
    <div id="friendsModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.7);z-index:10001;justify-content:center;align-items:center;">
      <div style="background:#fff;padding:30px 20px;border-radius:18px;max-width:400px;width:95vw;position:relative;direction:rtl;">
        <button id="closeFriendsModal" style="position:absolute;top:10px;left:10px;background:none;border:none;font-size:1.5em;cursor:pointer;">ร</button>
        <h2 style="text-align:center;">๐ฅ ูุงุฆูุฉ ุงูุฃุตุฏูุงุก</h2>
        <div id="friendsList" style="margin:15px 0 20px 0;min-height:40px;"></div>
        <form id="addFriendForm" style="display:flex;gap:8px;">
          <input type="text" id="addFriendInput" placeholder="ุงุณู ุงููุณุชุฎุฏู ูุฅุถุงูุชู" style="flex:1;padding:8px;border-radius:6px;border:1px solid #ccc;">
          <button type="submit" style="padding:8px 16px;border-radius:6px;background:#4f46e5;color:#fff;border:none;">ุฅุถุงูุฉ</button>
        </form>
        <div id="friendActionMsg" style="margin-top:10px;color:#10b981;text-align:center;"></div>
      </div>
    </div>

    <!-- ูุงูุฐุฉ ููุจุซูุฉ ููููุงู ุงูููููุฉ -->
    <div id="dailyQuestsModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.7);z-index:10001;justify-content:center;align-items:center;">
      <div style="background:#fff;padding:30px 20px;border-radius:18px;max-width:500px;width:95vw;position:relative;direction:rtl;max-height:80vh;overflow-y:auto;">
        <button id="closeDailyQuestsModal" style="position:absolute;top:10px;left:10px;background:none;border:none;font-size:1.5em;cursor:pointer;">ร</button>
        <h2 style="text-align:center;">๐ ุงูููุงู ุงูููููุฉ</h2>
        <div id="dailyQuestsList" style="margin:15px 0 20px 0;min-height:40px;"></div>
        <div id="dailyQuestsMsg" style="margin-top:10px;color:#10b981;text-align:center;"></div>
      </div>
    </div>

    <!-- ูุงูุฐุฉ ููุจุซูุฉ ููุธุงู ุงูุฏุนูุงุช -->
    <div id="inviteModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.7);z-index:10001;justify-content:center;align-items:center;">
      <div style="background:#fff;padding:30px 20px;border-radius:18px;max-width:500px;width:95vw;position:relative;direction:rtl;max-height:80vh;overflow-y:auto;">
        <button id="closeInviteModal" style="position:absolute;top:10px;left:10px;background:none;border:none;font-size:1.5em;cursor:pointer;">ร</button>
        <h2 style="text-align:center;">๐ ูุธุงู ุงูุฏุนูุงุช</h2>
        
        <!-- ููุฏ ุงูุฏุนูุฉ ุงูุฎุงุต -->
        <div style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:20px;border-radius:12px;margin:15px 0;text-align:center;">
          <h3 style="margin:0 0 10px 0;">ููุฏ ุฏุนูุชู ุงูุฎุงุต</h3>
          <div id="inviteCode" style="font-size:24px;font-weight:bold;letter-spacing:2px;background:rgba(255,255,255,0.2);padding:10px;border-radius:8px;margin:10px 0;">
            ...ุฌุงุฑู ุงูุชุญููู
          </div>
          <button id="copyInviteCode" style="background:rgba(255,255,255,0.2);border:2px solid white;color:white;padding:8px 16px;border-radius:6px;cursor:pointer;margin-top:10px;">
            ๐ ูุณุฎ ุงูููุฏ
          </button>
        </div>
        
        <!-- ุฅุญุตุงุฆูุงุช ุงูุฏุนูุงุช -->
        <div style="background:#f3f4f6;padding:15px;border-radius:10px;margin:15px 0;">
          <h4 style="margin:0 0 10px 0;">๐ ุฅุญุตุงุฆูุงุช ุฏุนูุงุชู</h4>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
            <div style="text-align:center;">
              <div id="totalInvited" style="font-size:20px;font-weight:bold;color:#4f46e5;">0</div>
              <div style="font-size:12px;color:#666;">ูุณุชุฎุฏููู ุฏุนูุชูู</div>
            </div>
            <div style="text-align:center;">
              <div id="totalRewards" style="font-size:20px;font-weight:bold;color:#10b981;">0</div>
              <div style="font-size:12px;color:#666;">ููุทุฉ ููุงูุฃุฉ</div>
            </div>
          </div>
        </div>
        
        <!-- ุงุณุชุฎุฏุงู ููุฏ ุฏุนูุฉ -->
        <div style="background:#f0f9ff;padding:15px;border-radius:10px;margin:15px 0;">
          <h4 style="margin:0 0 10px 0;">๐ ุงุณุชุฎุฏุงู ููุฏ ุฏุนูุฉ</h4>
          <form id="useInviteForm" style="display:flex;gap:8px;">
            <input type="text" id="useInviteInput" placeholder="ุฃุฏุฎู ููุฏ ุงูุฏุนูุฉ" style="flex:1;padding:8px;border-radius:6px;border:1px solid #ccc;text-transform:uppercase;">
            <button type="submit" style="padding:8px 16px;border-radius:6px;background:#10b981;color:#fff;border:none;">ุงุณุชุฎุฏุงู</button>
          </form>
        </div>
        
        <!-- ูุงุฆูุฉ ุงููุณุชุฎุฏููู ุงููุฏุนููู -->
        <div id="invitedUsersList" style="margin:15px 0;">
          <h4 style="margin:0 0 10px 0;">๐ฅ ุงููุณุชุฎุฏููู ุงูุฐูู ุฏุนูุชูู</h4>
          <div id="invitedUsers" style="max-height:200px;overflow-y:auto;">
            <!-- ุณูุชู ููุคูุง ุจุงูุฌุงูุงุณูุฑูุจุช -->
          </div>
        </div>
        
        <div id="inviteMsg" style="margin-top:10px;color:#10b981;text-align:center;"></div>
      </div>
    </div>

    <!-- ูุจู ูุณู </body> ูุจุงุดุฑุฉ ุฃุถู: -->
    <script src="game.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="daily-quests.js"></script>
    <script>
    // ุชูุนูู ุงููุถุน ุงููููู ุชููุงุฆูุงู ุญุณุจ ุชูุถูู ุงููุธุงู
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.body.classList.add('dark-mode');
    }
    // ุฒุฑ ุงูุชุจุฏูู
    const darkModeToggle = document.getElementById('darkModeToggle');
    darkModeToggle.onclick = function() {
      document.body.classList.toggle('dark-mode');
      // ุญูุธ ุงูุชูุถูู ูู localStorage
      if(document.body.classList.contains('dark-mode')) {
        localStorage.setItem('darkMode', '1');
      } else {
        localStorage.removeItem('darkMode');
      }
    };
    // ุงุณุชุนุงุฏุฉ ุงูุชูุถูู ุนูุฏ ุงูุฏุฎูู
    if(localStorage.getItem('darkMode')) {
      document.body.classList.add('dark-mode');
    }

    // ุฑุณู ุงูุฅุญุตุงุฆูุงุช ุจุนุฏ ุชุญููู ุจูุงูุงุช ุงููุงุนุจ
    function renderPlayerStatsChart(stats) {
      const ctx = document.getElementById('playerStatsChart').getContext('2d');
      if(window.playerStatsChartInstance) window.playerStatsChartInstance.destroy();
      window.playerStatsChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['ุงูููุงุท', 'ุงูุตูุงุฏูู ุงูููุชูุญุฉ', 'ุงูุฌูุงูุฑ', 'ุงูููุงุชูุญ', 'ุงููุขูุฆ', 'ุงููุฌูู'],
          datasets: [{
            label: 'ุฅุญุตุงุฆูุงุชู',
            data: [
              stats.score || 0,
              stats.boxesOpened || 0,
              stats.itemsCollected?.gem || 0,
              stats.itemsCollected?.key || 0,
              stats.itemsCollected?.pearl || 0,
              stats.itemsCollected?.star || 0
            ],
            backgroundColor: [
              '#6366f1','#f59e42','#10b981','#fbbf24','#38bdf8','#f43f5e'
            ],
            borderRadius: 8
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            title: { display: false }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }
    // ุงุณุชุฏุนุงุก ุงูุฑุณู ุนูุฏ ุชุญุฏูุซ ุงูุนุฑุถ
    const origUpdateDisplay = window.updateDisplay;
    window.updateDisplay = function() {
      if(origUpdateDisplay) origUpdateDisplay();
      // ุฌูุจ ุจูุงูุงุช ุงููุงุนุจ ูู ุงููุชุบูุฑุงุช ุงูุนุงูููุฉ
      renderPlayerStatsChart({
        score: window.score,
        boxesOpened: window.itemsCollected?.boxesOpened || 0,
        itemsCollected: window.itemsCollected
      });
    };
    // ุฑุณู ุฃููู ุนูุฏ ุงูุชุญููู
    window.addEventListener('DOMContentLoaded',()=>{
      renderPlayerStatsChart({
        score: window.score,
        boxesOpened: window.itemsCollected?.boxesOpened || 0,
        itemsCollected: window.itemsCollected
      });
    });

    const friendsBtn = document.getElementById('friendsBtn');
    const friendsModal = document.getElementById('friendsModal');
    const closeFriendsModal = document.getElementById('closeFriendsModal');
    const friendsListDiv = document.getElementById('friendsList');
    const addFriendForm = document.getElementById('addFriendForm');
    const addFriendInput = document.getElementById('addFriendInput');
    const friendActionMsg = document.getElementById('friendActionMsg');

    friendsBtn.onclick = () => {
      friendsModal.style.display = 'flex';
      loadFriendsList();
    };
    closeFriendsModal.onclick = () => {
      friendsModal.style.display = 'none';
      friendActionMsg.textContent = '';
    };
    window.onclick = function(e) {
      if(e.target === friendsModal) friendsModal.style.display = 'none';
    };

    async function loadFriendsList() {
      friendsListDiv.innerHTML = '...ุฌุงุฑู ุงูุชุญููู';
      const token = localStorage.getItem('token');
      if(!token) return friendsListDiv.innerHTML = 'ูุฌุจ ุชุณุฌูู ุงูุฏุฎูู';
      try {
        const res = await fetch(`${BACKEND_URL}/api/users/friends`, { headers: { 'Authorization': `Bearer ${token}` } });
        const data = await res.json();
        if(data.friends && data.friends.length) {
          friendsListDiv.innerHTML = data.friends.map(friend => `
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
              <span style="flex:1;">${friend}</span>
              <button onclick="removeFriend('${friend}')" style="background:#ef4444;color:#fff;border:none;border-radius:5px;padding:3px 10px;cursor:pointer;">ุญุฐู</button>
              <button onclick="inviteFriend('${friend}')" style="background:#10b981;color:#fff;border:none;border-radius:5px;padding:3px 10px;cursor:pointer;">ุฏุนูุฉ</button>
            </div>
          `).join('');
        } else {
          friendsListDiv.innerHTML = '<span style="color:#888">ูุง ููุฌุฏ ุฃุตุฏูุงุก ุจุนุฏ</span>';
        }
      } catch(e) {
        friendsListDiv.innerHTML = 'ุญุฏุซ ุฎุทุฃ ูู ุฌูุจ ุงูุฃุตุฏูุงุก';
      }
    }

    addFriendForm.onsubmit = async function(e) {
      e.preventDefault();
      const username = addFriendInput.value.trim();
      if(!username) return;
      const token = localStorage.getItem('token');
      try {
        const res = await fetch(`${BACKEND_URL}/api/users/friends/add`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ friendUsername: username })
        });
        const data = await res.json();
        if(res.ok) {
          friendActionMsg.textContent = 'ุชูุช ุฅุถุงูุฉ ุงูุตุฏูู ุจูุฌุงุญ';
          addFriendInput.value = '';
          loadFriendsList();
        } else {
          friendActionMsg.textContent = data.message || 'ุชุนุฐุฑ ุฅุถุงูุฉ ุงูุตุฏูู';
        }
      } catch(e) {
        friendActionMsg.textContent = 'ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุงูุฎุงุฏู';
      }
    };

    window.removeFriend = async function(friendUsername) {
      const token = localStorage.getItem('token');
      try {
        const res = await fetch(`${BACKEND_URL}/api/users/friends/remove`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ friendUsername })
        });
        const data = await res.json();
        if(res.ok) {
          friendActionMsg.textContent = 'ุชู ุญุฐู ุงูุตุฏูู';
          loadFriendsList();
        } else {
          friendActionMsg.textContent = data.message || 'ุชุนุฐุฑ ุญุฐู ุงูุตุฏูู';
        }
      } catch(e) {
        friendActionMsg.textContent = 'ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุงูุฎุงุฏู';
      }
    };

    window.inviteFriend = function(friendUsername) {
      // ููุง ููููู ุฑุจุท ุงูุฏุนูุฉ ุจูุธุงู ุงูุบุฑู ุฃู ุฅุฑุณุงู ุฑุณุงูุฉ ุนุจุฑ WebSocket
      alert('ุชู ุฅุฑุณุงู ุฏุนูุฉ ุฅูู ' + friendUsername + ' (ุชุฌุฑูุจู)');
    };

    // ุชูุนูู ูุธุงู ุงูููุงู ุงูููููุฉ
    let dailyQuestSystem;
    let notificationSystem;

    // ุชููุฆุฉ ุงูุฃูุธูุฉ ุนูุฏ ุชุญููู ุงูุตูุญุฉ
    window.addEventListener('DOMContentLoaded', () => {
        // ุชููุฆุฉ ูุธุงู ุงูุฅุดุนุงุฑุงุช
        notificationSystem = new NotificationSystem();
        
        // ุชููุฆุฉ ูุธุงู ุงูููุงู ุงูููููุฉ
        dailyQuestSystem = new DailyQuestSystem();
        
        // ุฅุนุฏุงุฏ ุฃุฒุฑุงุฑ ุงูููุงู ุงูููููุฉ
        setupDailyQuestsButtons();
    });

    function setupDailyQuestsButtons() {
        const dailyQuestsBtn = document.getElementById('dailyQuestsBtn');
        const dailyQuestsModal = document.getElementById('dailyQuestsModal');
        const closeDailyQuestsModal = document.getElementById('closeDailyQuestsModal');
        const dailyQuestsList = document.getElementById('dailyQuestsList');
        const dailyQuestsMsg = document.getElementById('dailyQuestsMsg');

        dailyQuestsBtn.onclick = () => {
            dailyQuestsModal.style.display = 'flex';
            loadDailyQuests();
        };

        closeDailyQuestsModal.onclick = () => {
            dailyQuestsModal.style.display = 'none';
            dailyQuestsMsg.textContent = '';
        };

        window.onclick = function(e) {
            if(e.target === dailyQuestsModal) dailyQuestsModal.style.display = 'none';
            if(e.target === friendsModal) friendsModal.style.display = 'none';
        };

        async function loadDailyQuests() {
            dailyQuestsList.innerHTML = '...ุฌุงุฑู ุงูุชุญููู';
            try {
                const activeQuests = dailyQuestSystem.getActiveQuests();
                const completedCount = dailyQuestSystem.getCompletedQuestsCount();
                const totalCount = dailyQuestSystem.getTotalQuestsCount();

                dailyQuestsList.innerHTML = `
                    <div style="
                        background: rgba(79, 70, 229, 0.1);
                        padding: 15px;
                        border-radius: 10px;
                        margin-bottom: 20px;
                        text-align: center;
                    ">
                        <div style="font-size: 18px; margin-bottom: 10px;">
                            ุงูุชูุฏู: ${completedCount}/${totalCount} ููุงู ููุชููุฉ
                        </div>
                        <div style="
                            background: rgba(255,255,255,0.2);
                            height: 10px;
                            border-radius: 5px;
                            overflow: hidden;
                        ">
                            <div style="
                                background: linear-gradient(90deg, #10b981, #059669);
                                height: 100%;
                                width: ${(completedCount / totalCount) * 100}%;
                                transition: width 0.3s ease;
                            "></div>
                        </div>
                    </div>

                    <div style="display: grid; gap: 15px;">
                        ${activeQuests.map(quest => `
                            <div style="
                                background: ${quest.completed ? 'rgba(16, 185, 129, 0.3)' : 'rgba(255,255,255,0.1)'};
                                padding: 15px;
                                border-radius: 10px;
                                border: 2px solid ${quest.completed ? '#10b981' : 'transparent'};
                            ">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span style="font-size: 24px;">${quest.icon}</span>
                                        <div>
                                            <h3 style="margin: 0; font-size: 16px;">${quest.title}</h3>
                                            <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.8;">
                                                ${quest.description.replace('{target}', quest.target)}
                                            </p>
                                        </div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 18px; font-weight: bold;">${quest.reward}</div>
                                        <div style="font-size: 12px;">ููุทุฉ</div>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 10px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                        <span style="font-size: 12px;">ุงูุชูุฏู</span>
                                        <span style="font-size: 12px;">${quest.progress}/${quest.target}</span>
                                    </div>
                                    <div style="
                                        background: rgba(255,255,255,0.2);
                                        height: 8px;
                                        border-radius: 4px;
                                        overflow: hidden;
                                    ">
                                        <div style="
                                            background: ${quest.completed ? '#10b981' : 'linear-gradient(90deg, #3b82f6, #2563eb)'};
                                            height: 100%;
                                            width: ${quest.progressPercentage}%;
                                            transition: width 0.3s ease;
                                        "></div>
                                    </div>
                                </div>
                                
                                ${quest.completed ? `
                                    <div style="
                                        text-align: center;
                                        margin-top: 10px;
                                        color: #10b981;
                                        font-weight: bold;
                                    ">
                                        โ ููุชููุฉ
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch(e) {
                dailyQuestsList.innerHTML = 'ุญุฏุซ ุฎุทุฃ ูู ุชุญููู ุงูููุงู ุงูููููุฉ';
            }
        }
    }

    // ุชุญุฏูุซ ุงูููุงู ุนูุฏ ุฃุญุฏุงุซ ุงููุนุจุฉ
    function updateDailyQuests(eventType, data) {
        if (dailyQuestSystem) {
            dailyQuestSystem.updateQuestsFromGameEvents(eventType, data);
        }
    }

    // ุชูุนูู ูุธุงู ุงูุฏุนูุงุช
    let inviteStats = null;

    // ุฅุนุฏุงุฏ ุฃุฒุฑุงุฑ ูุธุงู ุงูุฏุนูุงุช
    function setupInviteSystem() {
        const inviteBtn = document.getElementById('inviteBtn');
        const inviteModal = document.getElementById('inviteModal');
        const closeInviteModal = document.getElementById('closeInviteModal');
        const copyInviteCode = document.getElementById('copyInviteCode');
        const useInviteForm = document.getElementById('useInviteForm');
        const useInviteInput = document.getElementById('useInviteInput');
        const inviteMsg = document.getElementById('inviteMsg');

        inviteBtn.onclick = () => {
            inviteModal.style.display = 'flex';
            loadInviteStats();
        };

        closeInviteModal.onclick = () => {
            inviteModal.style.display = 'none';
            inviteMsg.textContent = '';
        };

        copyInviteCode.onclick = async () => {
            const inviteCode = document.getElementById('inviteCode').textContent;
            if (inviteCode && inviteCode !== '...ุฌุงุฑู ุงูุชุญููู') {
                try {
                    await navigator.clipboard.writeText(inviteCode);
                    inviteMsg.textContent = 'ุชู ูุณุฎ ููุฏ ุงูุฏุนูุฉ!';
                    setTimeout(() => inviteMsg.textContent = '', 3000);
                } catch (err) {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = inviteCode;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    inviteMsg.textContent = 'ุชู ูุณุฎ ููุฏ ุงูุฏุนูุฉ!';
                    setTimeout(() => inviteMsg.textContent = '', 3000);
                }
            }
        };

        useInviteForm.onsubmit = async function(e) {
            e.preventDefault();
            const code = useInviteInput.value.trim().toUpperCase();
            if (!code) return;

            const token = localStorage.getItem('token');
            try {
                const res = await fetch(`${BACKEND_URL}/api/users/use-invite-code`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ inviteCode: code })
                });
                const data = await res.json();
                
                if (res.ok) {
                    inviteMsg.textContent = data.message;
                    useInviteInput.value = '';
                    // ุชุญุฏูุซ ุงูููุงุท ูู ุงููุนุจุฉ
                    if (window.score !== undefined) {
                        window.score += data.reward;
                        if (window.updateDisplay) {
                            window.updateDisplay();
                        }
                    }
                    // ุฅุนุงุฏุฉ ุชุญููู ุงูุฅุญุตุงุฆูุงุช
                    loadInviteStats();
                } else {
                    inviteMsg.textContent = data.message;
                }
            } catch (e) {
                inviteMsg.textContent = 'ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุงูุฎุงุฏู';
            }
        };
    }

    async function loadInviteStats() {
        const token = localStorage.getItem('token');
        if (!token) return;

        try {
            const res = await fetch(`${BACKEND_URL}/api/users/invite-stats`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await res.json();
            
            if (res.ok) {
                inviteStats = data;
                displayInviteStats(data);
            }
        } catch (e) {
            console.error('Error loading invite stats:', e);
        }
    }

    function displayInviteStats(data) {
        // ุนุฑุถ ููุฏ ุงูุฏุนูุฉ
        document.getElementById('inviteCode').textContent = data.inviteCode;
        
        // ุนุฑุถ ุงูุฅุญุตุงุฆูุงุช
        document.getElementById('totalInvited').textContent = data.totalInvited;
        document.getElementById('totalRewards').textContent = data.inviteRewards.toLocaleString();
        
        // ุนุฑุถ ูุงุฆูุฉ ุงููุณุชุฎุฏููู ุงููุฏุนููู
        const invitedUsersDiv = document.getElementById('invitedUsers');
        if (data.invitedUsersDetails && data.invitedUsersDetails.length > 0) {
            invitedUsersDiv.innerHTML = data.invitedUsersDetails.map(user => `
                <div style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 8px;
                    background: white;
                    border-radius: 6px;
                    margin-bottom: 5px;
                    border: 1px solid #e5e7eb;
                ">
                    <div>
                        <div style="font-weight: bold;">${user.username}</div>
                        <div style="font-size: 12px; color: #666;">
                            ุงูุถู: ${new Date(user.createdAt).toLocaleDateString('ar-SA')}
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: bold; color: #4f46e5;">${user.score.toLocaleString()}</div>
                        <div style="font-size: 12px; color: #666;">ููุทุฉ</div>
                    </div>
                </div>
            `).join('');
        } else {
            invitedUsersDiv.innerHTML = '<p style="text-align: center; color: #666;">ูู ุชุฏุน ุฃู ูุณุชุฎุฏู ุจุนุฏ</p>';
        }
    }

    // ุฅุถุงูุฉ setupInviteSystem ุฅูู DOMContentLoaded
    window.addEventListener('DOMContentLoaded', () => {
        // ุชููุฆุฉ ูุธุงู ุงูุฅุดุนุงุฑุงุช
        notificationSystem = new NotificationSystem();
        
        // ุชููุฆุฉ ูุธุงู ุงูููุงู ุงูููููุฉ
        dailyQuestSystem = new DailyQuestSystem();
        
        // ุฅุนุฏุงุฏ ุฃุฒุฑุงุฑ ุงูููุงู ุงูููููุฉ
        setupDailyQuestsButtons();
        
        // ุฅุนุฏุงุฏ ูุธุงู ุงูุฏุนูุงุช
        setupInviteSystem();
    });
    </script>
</body>
</html>
